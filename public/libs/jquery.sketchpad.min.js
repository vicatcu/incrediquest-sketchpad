/*sketchpad.pro - free online drawing*/!function(t){"use strict";function e(){this.registeredCallbacks={},this.registeredCallbacksOnce={}}function s(t){function s(t){var e=d.normalize(t.offsetY,0,d.hueCanvas.height),s=e/d.hueCanvas.height*360;d.changeHue(s)}function i(t){var e=d.normalize(t.offsetX,0,d.paletteCanvas.width),s=d.normalize(t.offsetY,0,d.paletteCanvas.height),i=e/d.paletteCanvas.width*100,o=s/d.paletteCanvas.height*100;d.pickPalette(i,o)}function r(t){var e=d.normalize(t.offsetX,0,d.alphaCanvas.width),s=e/d.alphaCanvas.width*1;d.changeAlpha(s)}function a(t){d.changeAlpha(d.color.alpha-t.deltaX/100/2),t.preventDefault()}function n(t){d.changeHue(d.color.hue-t.deltaY/2),t.preventDefault()}function l(t){d.pickPalette(d.color.saturation-t.deltaX/2,d.color.value-t.deltaY/2),t.preventDefault()}e.call(this,t),"object"!=typeof t.keyModifiers&&(t.keyModifiers={});var c=t.containerEl;this.containerEl=c,c.classList.add("colorpalette");this.width=200,this.height=220,this.color={hue:0,saturation:0,value:0,red:0,green:0,blue:0,alpha:1},c.style.position="relative",c.style.width="200px",c.style.height="220px",c.style.display="inline-block",this.colorBgEl=document.createElement("div"),this.colorBgEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')",this.colorBgEl.style.backgroundSize="16px",this.colorBgEl.style.backgroundPosition="50% 50%",this.colorBgEl.className="color-bg",this.colorBgEl.style.width="200px",this.colorBgEl.style.height=Math.floor(20)+"px",this.colorBgEl.style.borderRadius=window.radius+"px "+window.radius+"px 0px 0px",this.colorBgEl.style.overflow="hidden",this.colorEl=document.createElement("div"),this.colorEl.className="color",this.colorEl.style.width="100%",this.colorEl.style.height="100%",this.colorEl.style.cursor="pointer",this.colorBgEl.appendChild(this.colorEl),this.colorBgEl.style.position="absolute",this.colorBgEl.style.top="0px",this.colorBgEl.style.left="0px",this.paletteCanvas=document.createElement("canvas"),this.paletteCanvas.className="palette",this.paletteCanvas.width=180,this.paletteCanvas.height=Math.floor(180),this.paletteContext2d=this.paletteCanvas.getContext("2d"),this.paletteIData=this.paletteContext2d.createImageData(this.paletteCanvas.width,this.paletteCanvas.height),this.paletteCanvas.style.cursor="crosshair",this.paletteCanvas.style.position="absolute",this.paletteCanvas.style.left="0px",this.paletteCanvas.style.top=Math.floor(20)+"px",this.palettePointerEl=document.createElement("div"),this.palettePointerEl.className="pointer palette-pointer",this.palettePointerEl.position="absolute",this.palettePointerEl.style.width="12px",this.palettePointerEl.style.height="12px",this.palettePointerEl.style.backgroundColor="white",this.palettePointerEl.style.position="absolute",this.palettePointerEl.style.borderRadius="50%",this.palettePointerEl.style.cursor="crosshair",this.palettePointerEl.style.boxShadow="inset 0 0 2px #000",this.hueCanvas=document.createElement("canvas"),this.hueCanvas.className="hue",this.hueCanvas.width=20,this.hueCanvas.height=180,this.hueContext2d=this.hueCanvas.getContext("2d"),this.hueIData=this.hueContext2d.createImageData(this.hueCanvas.width,this.hueCanvas.height),this.hueCanvas.style.cursor="row-resize",this.hueCanvas.style.position="absolute",this.hueCanvas.style.top="20px",this.hueCanvas.style.left="180px",this.hueSliderEl=document.createElement("div"),this.hueSliderEl.className="slider hue-slider",this.hueSliderEl.style.width="24px",this.hueSliderEl.style.height="6.6px",this.hueSliderEl.style.position="absolute",this.hueSliderEl.style.top="22px",this.hueSliderEl.style.left="178px",this.hueSliderEl.style.backgroundColor="white",this.hueSliderEl.style.cursor="row-resize",this.hueSliderEl.style.boxShadow="inset 0 0 2px #000",this.hueSliderEl.style.zIndex=100,this.alphaCanvas=document.createElement("canvas"),this.alphaCanvas.className="alpha",this.alphaCanvas.width=200,this.alphaCanvas.height=20,this.alphaContext2d=this.alphaCanvas.getContext("2d"),this.alphaIData=this.alphaContext2d.createImageData(this.alphaCanvas.width,this.alphaCanvas.height),this.alphaCanvas.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')",this.alphaCanvas.style.backgroundSize="16px",this.alphaCanvas.style.backgroundPosition="50% 50%",this.alphaCanvas.style.cursor="col-resize",this.alphaCanvas.style.position="absolute",this.alphaCanvas.style.top="200px",this.alphaCanvas.style.left="0px",this.alphaCanvas.style.borderRadius="0px 0px "+window.radius+"px "+window.radius+"px",this.alphaCanvas.style.overflow="hidden",this.alphaSliderEl=document.createElement("div"),this.alphaSliderEl.className="slider alpha-slider",this.alphaSliderEl.style.width="6px",this.alphaSliderEl.style.height="24.2px",this.alphaSliderEl.style.backgroundColor="white",this.alphaSliderEl.style.position="absolute",this.alphaSliderEl.style.top="197.8px",this.alphaSliderEl.style.left=this.alphaCanvas.width-3+"px",this.alphaSliderEl.style.cursor="col-resize",this.alphaSliderEl.style.boxShadow="inset 0 0 2px #000",this.alphaSliderEl.style.zIndex=100,this.redInput=document.createElement("input"),this.redInput.title="R:",this.greenInput=document.createElement("input"),this.greenInput.title="G:",this.blueInput=document.createElement("input"),this.blueInput.title="B:",this.alphaInput=document.createElement("input"),this.alphaInput.title="A:",this.valuesEl=document.createElement("div");var d=this;return[this.redInput,this.greenInput,this.blueInput,this.alphaInput].forEach(function(t){var e=document.createElement("span");e.textContent=t.title,d.valuesEl.appendChild(e),d.valuesEl.appendChild(t),t.type="number",t.className=t.title,t===d.alphaInput?(t.min=0,t.max=1,t.step=.01,t.maxLength=4):(t.min=0,t.max=255,t.step=1,t.maxLength=3),t.addEventListener("change",function(){d.updateFromInputs()})}),c.appendChild(this.colorBgEl),c.appendChild(this.paletteCanvas),c.appendChild(this.hueCanvas),c.appendChild(this.alphaCanvas),c.appendChild(this.hueSliderEl),c.appendChild(this.alphaSliderEl),c.appendChild(this.palettePointerEl),this.drawHue(),this.drawPalette(this.color.hue),o(this.hueCanvas,"slide",s),o(this.colorEl,"tap",function(){var t=d.getColor();d.dispatch("set",{color:t})}),o(this.paletteCanvas,"slide",i),o(this.alphaCanvas,"slide",r),this.setHueSlider(0),t.color&&this.setColor(t.color),this.alphaCanvas.addEventListener("wheel",a),this.alphaSliderEl.addEventListener("wheel",a),this.hueCanvas.addEventListener("wheel",n),this.hueSliderEl.addEventListener("wheel",n),this.paletteCanvas.addEventListener("wheel",l),this.palettePointerEl.addEventListener("wheel",l),this.keyshortcuts=new h,this.keyshortcuts.disable(),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:38,repeatable:!0},t.keyModifiers),function(){d.changeHue(d.color.hue-1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:40,repeatable:!0},t.keyModifiers),function(){d.changeHue(d.color.hue+1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:37,repeatable:!0},t.keyModifiers),function(){d.changeAlpha(d.color.alpha-.01)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:39,repeatable:!0},t.keyModifiers),function(){d.changeAlpha(d.color.alpha+.01)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:38,repeatable:!0},t.keyModifiers),function(){d.pickPalette(d.color.saturation,d.color.value-1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:40,repeatable:!0},t.keyModifiers),function(){d.pickPalette(d.color.saturation,d.color.value+1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:37,repeatable:!0},t.keyModifiers),function(){d.pickPalette(d.color.saturation-1,d.color.value)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:39,repeatable:!0},t.keyModifiers),function(){d.pickPalette(d.color.saturation+1,d.color.value)}),this}function i(t){var e=t.getBoundingClientRect();return{x:0-e.left,y:0-e.top}}function o(t,e,s,o){function r(){var t="";return window.getSelection?t=window.getSelection().toString():void 0!==document.selection&&"Text"===document.selection.type&&(t=document.selection.createRange().text),t}function a(e){var o,r,a=i(t);for(o=0;o<e.changedTouches.length;o+=1)r=e.changedTouches[o],r.offsetX=r.clientX+a.x,r.offsetY=r.clientY+a.y,s(r)}var n,h;switch(e){case"swipe-right":console.log("adding swipe right"),t.addEventListener("touchstart",function(t){n=t.changedTouches[0]},o),t.addEventListener("mousedown",function(t){console.log("mdsr"),n=t},o),t.addEventListener("touchend",function(t){(h=t.changedTouches[t.changedTouches.length-1])&&n&&h.screenX-n.screenX>30&&!r()&&"text"!==document.activeElement.type&&s(t)},o),t.addEventListener("mouseup",function(t){(h=t)&&n&&h.screenX-n.screenX>30&&!r()&&"text"!==document.activeElement.type&&s(t)},o);break;case"hover-in":t.addEventListener("touchstart",function(t){var e;for(e=0;e<t.changedTouches.length;e+=1)s(t.changedTouches[e])},o),t.addEventListener("touchmove",function(t){var e;for(e=0;e<t.changedTouches.length;e+=1)s(t.changedTouches[e])},o),t.addEventListener("mouseover",s,o);break;case"hover-out":t.addEventListener("mouseout",s,o);break;case"tap":t.addEventListener("touchstart",function(t){t.preventDefault(),document.activeElement!==t.target&&"INPUT"===document.activeElement.tagName&&document.activeElement.blur();var e;for(e=0;e<t.changedTouches.length;e+=1)t.changedTouches[e].stopPropagation=t.stopPropagation&&t.stopPropagation.bind(t),t.changedTouches[e].preventDefault=t.preventDefault&&t.preventDefault.bind(t),s(t.changedTouches[e]);t.preventMouseFallback=!0},o),t.addEventListener("mousedown",function(t){s(t)},o);break;case"pop":t.addEventListener("touchend",function(t){t.preventDefault(),document.activeElement!==t.target&&"INPUT"===document.activeElement.tagName&&document.activeElement.blur();var e;for(e=0;e<t.changedTouches.length;e+=1)t.changedTouches[e].stopPropagation=t.stopPropagation&&t.stopPropagation.bind(t),t.changedTouches[e].preventDefault=t.preventDefault&&t.preventDefault.bind(t),s(t.changedTouches[e]);t.preventMouseFallback=!0},o),t.addEventListener("mouseup",function(t){s(t)},o);break;case"slide":t.addEventListener("mousedown",s,o),t.addEventListener("mouseup",s,o),t.addEventListener("mousemove",function(t){(t.buttons||void 0===t.buttons&&t.which)&&s(t)},o),t.addEventListener("touchstart",a,o),t.addEventListener("touchend",a,o),t.addEventListener("touchmove",a,o);break;default:t.addEventListener(e,s,o)}}function r(t){function s(t){l.setFont(t.target.value)}function i(t){var e=l.normalize(l.width+t.offsetX,0,l.width),s=l.minSize+e/l.width*(l.maxSize-l.minSize);l.setSize(s)}function r(t){t.preventDefault(),l.setSize(l.size-t.deltaY/2)}function a(t){t.preventDefault(),l.setSize(l.size-t.deltaX/2)}e.call(this,t),"object"!=typeof t.keyModifiers&&(t.keyModifiers={});var n=t.containerEl;this.containerEl=n,n.classList.add("fontpalette");this.width=200,this.height=220,this.font="Georgia",this.size=60,this.color={hue:0,saturation:0,value:0,red:0,green:0,blue:0,alpha:1},this.minSize=t.minSize||10,this.maxSize=t.maxSize||100,this.fontList=t.fontList||["Arial","Arial Black","Arial Narrow","Courier New","Lucida Sans Typewriter","Papyrus","Tahoma","Times New Roman","Trebuchet MS","Comic Sans MS","Verdana"],n.style.position="relative",n.style.width="200px",n.style.height="220px",n.style.display="inline-block";var l=this;this.fontListSelectEl=document.createElement("select"),this.fontListSelectEl.style.height=Math.floor(20)+"px",this.fontListSelectEl.style.width="100%",this.fontListSelectEl.style.lineHeight=Math.floor(20)+"px",this.fontList.forEach(function(t){var e=document.createElement("option");e.value=t,e.textContent=t,l.fontListSelectEl.appendChild(e)}),this.fontListSelectEl.addEventListener("change",s),this.previewCanvas=document.createElement("canvas"),this.previewCanvas.className="palette",this.previewCanvas.width=200,this.previewCanvas.height=Math.floor(180),this.previewContext2d=this.previewCanvas.getContext("2d"),this.paletteIData=this.previewContext2d.createImageData(this.previewCanvas.width,this.previewCanvas.height),this.previewCanvas.style.cursor="crosshair",this.previewCanvas.style.position="absolute",this.previewCanvas.style.left="0px",this.previewCanvas.style.top="20px",this.sizeEl=document.createElement("div"),this.sizeEl.style.backgroundColor="transparent",this.sizeEl.style.position="absolute",this.sizeEl.className="bg",this.sizeEl.style.top="200px",this.sizeEl.style.left="0px",this.sizeEl.style.cursor="col-resize",this.sizeEl.style.borderLeft="200px solid transparent",this.sizeEl.style.borderBottom="20px solid black",this.sizeSliderEl=document.createElement("div"),this.sizeSliderEl.className="slider hue-slider",this.sizeSliderEl.style.marginLeft="-3px",this.sizeSliderEl.style.marginTop="-2.2px",this.sizeSliderEl.style.width="6px",this.sizeSliderEl.style.height="24.2px",this.sizeSliderEl.style.position="absolute",this.sizeSliderEl.style.top="200px",this.sizeSliderEl.style.left="0px",this.sizeSliderEl.style.backgroundColor="white",this.sizeSliderEl.style.cursor="col-resize",this.sizeSliderEl.style.boxShadow="inset 0 0 2px #000",this.sizeSliderEl.style.zIndex="100",this.previewCanvas.addEventListener("wheel",r),this.sizeSliderEl.addEventListener("wheel",a),this.sizeEl.addEventListener("wheel",a),o(this.sizeEl,"slide",i),this.keyshortcuts=new h,this.keyshortcuts.disable(),this.keyshortcuts.addShortcut(Object.assign({shiftKey:!1,keyCode:37,repeatable:!0},t.keyModifiers),function(){l.setSize(l.size-1)}),this.keyshortcuts.addShortcut(Object.assign({shiftKey:!1,keyCode:39,repeatable:!0},t.keyModifiers),function(){l.setSize(l.size+1)}),this.redrawPreview(),n.appendChild(this.fontListSelectEl),n.appendChild(this.previewCanvas),n.appendChild(this.sizeEl),n.appendChild(this.sizeSliderEl)}function a(t){e.call(this,t),"object"!=typeof t.keyModifiers&&(t.keyModifiers={});var s=t.containerEl;this.containerEl=s,s.classList.add("fontpalette");this.width=60,this.height=220,this.keyshortcuts=new h,s.style.position="relative",s.style.width="60px",s.style.height="220px",s.style.display="inline-block",s.style.fontSize="12px"}function n(t){if(e.call(this,t),this.File=void 0,this.config=t,this.postPdfUrl=X&&X.postPdfUrl||"https://uploader.imagehost.pro:3443/upload",this.postImageUrl=X&&X.postImageUrl||"https://uploader.imagehost.pro:3443/upload",this.postWebshotUrl=X&&X.postWebshotUrl||"https://uploader.imagehost.pro:3443/webshot?site=",this.proxyImageUrl=X&&X.proxyImageUrl||"https://imagehost.pro/proxy",this.proxyExcludedDomain=X&&X.proxyExcludedDomain||"imagehost.pro",t.file&&this.uploadFile(t.file),t.url)if(this.isDataURL(t.url)){if(t.file=this.dataURItoFile(t.url),!t.file)return console.error("Error - wrong data url",t.url),this;this.uploadFile(t.file)}else this.proxyUrl(t.url);return this.progressbar=new d({name:t.url,progressParentEl:t.progressParentEl||window.document.body,style:{position:"absolute",top:0,left:0,zIndex:200,height:"2px",width:"2px",backgroundColor:"rgba(155, 0, 0, 0.5)"}}),this}function h(t){e.call(this,t),this.shortcuts=[],this.registerEvents()}function l(){return{r:Math.floor(255*Math.random()),g:Math.floor(0*Math.random()),b:Math.floor(0*Math.random()),a:1}}function c(t){function s(t){var e=l.normalize(t.offsetX,0,l.paletteCanvas.width),s=l.normalize(t.offsetY,0,l.paletteCanvas.height);l.pickPalette(e,s)}function i(t){var e=l.normalize(t.offsetX,0,l.width),s=e/l.width*1;l.changeThreshold(s)}function r(t){l.changeThreshold(l.threshold-t.deltaX/100/2),t.preventDefault()}function a(t){l.pickPalette(l.x-t.deltaX/2,l.y-t.deltaY/2),t.preventDefault()}e.call(this,t),"object"!=typeof t.keyModifiers&&(t.keyModifiers={});var n=t.containerEl;this.containerEl=n,n.classList.add("Pixelpicker");this.width=200,this.height=220,this.threshold=.15,this.x=0,this.y=0,this.color={hue:0,saturation:0,value:0,red:0,green:0,blue:0,alpha:1},n.style.position="relative",n.style.width="200px",n.style.height="220px",n.style.display="inline-block",this.colorBgEl=document.createElement("div"),this.colorBgEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')",this.colorBgEl.style.backgroundSize="16px",this.colorBgEl.style.backgroundPosition="50% 50%",this.colorBgEl.className="color-bg",this.colorBgEl.style.width="200px",this.colorBgEl.style.height=Math.floor(20)+"px",this.colorBgEl.style.borderRadius=window.radius+"px "+window.radius+"px 0px 0px",this.colorBgEl.style.overflow="hidden",this.colorEl=document.createElement("div"),this.colorEl.className="color",this.colorEl.style.width="100%",this.colorEl.style.height="100%",this.colorEl.style.cursor="pointer",this.colorBgEl.appendChild(this.colorEl),this.colorBgEl.style.position="absolute",this.colorBgEl.style.top="0px",this.colorBgEl.style.left="0px",this.paletteBgEl=document.createElement("div"),this.paletteBgEl.className="palette-bg",this.paletteBgEl.style.position="absolute",this.paletteBgEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')",this.paletteBgEl.style.backgroundSize="16px",this.paletteBgEl.style.backgroundPosition="50% 50%",this.paletteBgEl.style.width="200px",this.paletteBgEl.style.height=Math.floor(200)+"px",this.paletteBgEl.style.borderRadius=window.radius+"px "+window.radius+"px 0px 0px",this.paletteBgEl.style.overflow="hidden",this.paletteBgEl.style.left="0px",this.paletteBgEl.style.top=Math.floor(20)+"px",this.paletteCanvas=document.createElement("canvas"),this.paletteCanvas.className="palette",this.paletteCanvas.width=200,this.paletteCanvas.height=Math.floor(200),this.paletteContext2d=this.paletteCanvas.getContext("2d"),this.paletteIData=this.paletteContext2d.createImageData(this.paletteCanvas.width,this.paletteCanvas.height),this.paletteCanvas.style.cursor="crosshair",this.paletteCanvas.style.position="absolute",this.paletteCanvas.style.left="0px",this.paletteCanvas.style.top=Math.floor(20)+"px";var l=this,c=document.createElement("img");return c.addEventListener("load",function(){l.paletteContext2d.drawImage(c,0,0,c.width,c.height,0,0,l.width,l.width*(c.height/c.width))}),c.src=t.imageSrc,this.palettePointerEl=document.createElement("div"),this.palettePointerEl.className="pointer palette-pointer",this.palettePointerEl.position="absolute",this.palettePointerEl.style.width="12px",this.palettePointerEl.style.height="12px",this.palettePointerEl.style.backgroundColor="transparent",this.palettePointerEl.style.position="absolute",this.palettePointerEl.style.border="1px solid white",this.palettePointerEl.style.borderRadius="50%",this.palettePointerEl.style.cursor="crosshair",this.palettePointerEl.style.boxShadow="inset 0 0 2px #000",this.thresholdSliderEl=document.createElement("div"),this.thresholdSliderEl.className="slider alpha-slider",this.thresholdSliderEl.style.width="6px",this.thresholdSliderEl.style.height="24.2px",this.thresholdSliderEl.style.backgroundColor="transparent",this.thresholdSliderEl.style.border="1px solid white",this.thresholdSliderEl.style.position="absolute",this.thresholdSliderEl.style.top="-2.2px",this.thresholdSliderEl.style.left=this.width-3+"px",this.thresholdSliderEl.style.cursor="col-resize",this.thresholdSliderEl.style.boxShadow="inset 0 0 2px #000",this.thresholdSliderEl.style.zIndex=100,this.redInput=document.createElement("input"),this.redInput.title="R:",this.greenInput=document.createElement("input"),this.greenInput.title="G:",this.blueInput=document.createElement("input"),this.blueInput.title="B:",this.alphaInput=document.createElement("input"),this.alphaInput.title="A:",this.valuesEl=document.createElement("div"),[this.redInput,this.greenInput,this.blueInput,this.alphaInput].forEach(function(t){var e=document.createElement("span");e.textContent=t.title,l.valuesEl.appendChild(e),l.valuesEl.appendChild(t),t.type="number",t.className=t.title,t===l.alphaInput?(t.min=0,t.max=1,t.step=.01,t.maxLength=4):(t.min=0,t.max=255,t.step=1,t.maxLength=3),t.addEventListener("change",function(){l.updateFromInputs()})}),n.appendChild(this.colorBgEl),n.appendChild(this.paletteBgEl),n.appendChild(this.paletteCanvas),n.appendChild(this.thresholdSliderEl),n.appendChild(this.palettePointerEl),o(this.paletteCanvas,"slide",s),o(this.colorEl,"slide",i),this.colorEl.addEventListener("wheel",r),this.thresholdSliderEl.addEventListener("wheel",r),this.setThresholdSlider(0),t.color&&this.setColor(t.color),this.paletteCanvas.addEventListener("wheel",a),this.palettePointerEl.addEventListener("wheel",a),this.keyshortcuts=new h,this.keyshortcuts.disable(),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:37,repeatable:!0},t.keyModifiers),function(){l.changeThreshold(l.threshold-.01)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:39,repeatable:!0},t.keyModifiers),function(){l.changeThreshold(l.threshold+.01)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:38,repeatable:!0},t.keyModifiers),function(){l.pickPalette(l.color.saturation,l.color.value-1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:40,repeatable:!0},t.keyModifiers),function(){l.pickPalette(l.color.saturation,l.color.value+1)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:37,repeatable:!0},t.keyModifiers),function(){l.pickPalette(l.color.saturation-1,l.color.value)}),this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:39,repeatable:!0},t.keyModifiers),function(){l.pickPalette(l.color.saturation+1,l.color.value)}),this}function d(t){return e.call(this,t),this.config=Object.assign({},t),this.prepareLoadingElements(),this}function p(t){return this.images=[],this.config=t,this.sketchpad=t.sketchpad,this}function u(t){return u.prototype.instance+=1,this.timestamp=(new Date).getTime(),this.type=t.type||"draw",this.uid=t.uid,this.id=t.id,this.layers=t.layers,this.tool=t.tool,this.font=t.font,this.color=t.color,this.fillColor=t.fillColor,this.size=t.size,this.center=t.center,this.listT=[],this.listX=[],this.listY=[],this.listP=[],this.lastT=NaN,this.lastX=NaN,this.lastY=NaN,this.lastP=NaN,this.lastSendPointer=0,this.lastDrawPointer=0,this.sketchpad=t.sketchpad,this.viewportX=this.sketchpad.viewportX,this.viewportY=this.sketchpad.viewportY,this.scale=this.sketchpad.scale,this.rotation=this.sketchpad.rotation,this.width=this.sketchpad.width,this.height=this.sketchpad.height,this.UID=this.sketchpad.UID,this.url=t.url,this}function g(t,e,s){var i=t.currentStyle||window.getComputedStyle(t,null),o=parseInt(i.borderLeftWidth,10)||0,r=parseInt(i.borderTopWidth,10)||0,a=t.getBoundingClientRect();return{x:e-o-a.left,y:s-r-a.top}}function f(t){var e,s=["a","e","i","o","u","y"],i=["b","c","d","g","h","j","k","l","m","n","p","r","s","t","v","w"],o="";for(e=0;e<t;e+=1)o+=i[Math.floor(Math.random()*i.length)]+s[Math.floor(Math.random()*s.length)];return o.substring(0,t)}function y(t){function s(){a.lastSendPointerX===a.pointerX&&a.lastSendPointerY===a.pointerY||(a.lastSendPointerX=a.pointerX,a.lastSendPointerY=a.pointerY,a.sendMessageToServer({cmd:"pointer-move",x:a.pointerX,y:a.pointerY})),setTimeout(s,a.syncPointerDataFrequency)}function i(t){a.openConnection(t,a.token);var e=Object.assign({},a.config);delete e.ws,delete e.containerEl;var s={cmd:"open",user_id:a.UID,user_color:a.COLOR,room_token:a.token,room_password:a.password,room_config:e,viewportX:parseFloat(a.viewportX)||0,viewportY:parseFloat(a.viewportY)||0,width:parseFloat(a.width)||0,height:parseFloat(a.height)||0,viewportScale:parseFloat(a.scale)||1,viewportZRotation:parseFloat(a.rotation)||0},i=JSON.stringify(s);a.ws.send(i),a.dispatch("initConnection")}e.call(this,t),console.log("sketchpad.js","Sketchpad::constructor",t);var o=f(6),r=l();t.features||(t.features="*"),this.initialised=!1,this.drawingPaused=!1,this.pausedQueue=[],this.displayCrosshair=!0,this.displayGrid=!1,this.UID=o[0].toUpperCase()+o.substr(1),this.user={},this.COLOR=r,this.editorsCount=0,this.viewersCount=0,this.resources=new p({sketchpad:this}),t=t||{},X.watermarkImageSrc&&(this.watermark=new Image,this.watermark.src=X.watermarkImageSrc,this.watermark.title=X.watermarkTitle,this.watermark.alt="sketchpad.pro",this.watermark.style.cursor="help",this.watermark.onload=function(){var t=this;t.addEventListener("click",function(){alert(t.title)})},this.watermark.style.position="absolute",this.watermark.style.right="0px",this.watermark.style.bottom="0px",this.watermark.crossOrigin="anonymous"),this.password=t.password||"",this.setMetaConfigFreeze=NaN,this.config=t,this.token=t.token||"#public",this.ws=t.ws||{addEventListener:function(){},send:function(){}},this.containerEl=t.containerEl||document.body,this.progressParentEl=t.progressParentEl||this.containerEl,this.syncNetworkDataFrequency=t.syncNetworkDataFrequency||Math.round(1e3),this.syncPointerDataFrequency=t.syncPointerDataFrequency||Math.round(100),this.centerViewport=!0,this.readOnly=t.readOnly||!1,this.tools={},this.tool=null,this.viewportX=parseFloat(t.viewportX)||0,this.viewportY=parseFloat(t.viewportY)||0,this.scale=parseFloat(t.viewportScale)||1,this.rotation=parseFloat(t.viewportZRotation)||0,this.LAYER_FRONT="F",this.LAYER_BACK="B",this.receivingHistory=!1,this.inputs={},this.backgroundCanvas=document.createElement("canvas"),this.backgroundCanvas.style.width="100%",this.backgroundCanvas.style.height="100%",this.backgroundCanvas.style.position="absolute",this.backgroundCanvas.style.transformOrigin="0 0",this.backgroundCanvas.style.webkitTransformOrigin="0 0",this.backgroundCanvas.style.MozTransformOrigin="0 0",this.backgroundCanvas.style.msTransformOrigin="0 0",this.backgroundCanvas.style.OTransformOrigin="0 0",this.containerEl.appendChild(this.backgroundCanvas),this.backgroundIFrame=document.createElement("iframe"),this.backgroundIFrame.style.display="none",this.backgroundIFrame.style.position="absolute",this.backgroundIFrame.style.transformOrigin="0 0",this.backgroundIFrame.style.webkitTransformOrigin="0 0",this.backgroundIFrame.style.MozTransformOrigin="0 0",this.backgroundIFrame.style.msTransformOrigin="0 0",this.backgroundIFrame.style.OTransformOrigin="0 0",this.backgroundIFrame.style.border=0,this.containerEl.appendChild(this.backgroundIFrame),this.background=document.createElement("img"),this.background.style.position="absolute",this.background.style.transformOrigin="0 0",this.background.style.webkitTransformOrigin="0 0",this.background.style.MozTransformOrigin="0 0",this.background.style.msTransformOrigin="0 0",this.background.style.OTransformOrigin="0 0",this.containerEl.appendChild(this.background),this.hudsEl=document.createElement("div"),this.hudsEl.style.zIndex=1,this.hudsEl.style.width="100%",this.hudsEl.style.height="100%",this.hudsEl.style.position="absolute",this.hudsEl.style.backgroundPosition="center center",this.hudsEl.style.transformOrigin="0 0",this.hudsEl.style.webkitTransformOrigin="0 0",this.hudsEl.style.MozTransformOrigin="0 0",this.hudsEl.style.msTransformOrigin="0 0",this.hudsEl.style.OTransformOrigin="0 0",this.hudsEl.style.transition="opacity .5s",this.containerEl.appendChild(this.hudsEl),this.projectorEl=document.createElement("div"),this.projectorEl.style.zIndex=2,this.projectorEl.style.width="100%",this.projectorEl.style.height="100%",this.projectorEl.style.position="absolute",this.projectorEl.style.backgroundPosition="center center",this.projectorEl.style.transformOrigin="0 0",this.projectorEl.style.webkitTransformOrigin="0 0",this.projectorEl.style.MozTransformOrigin="0 0",this.projectorEl.style.msTransformOrigin="0 0",this.projectorEl.style.OTransformOrigin="0 0",this.pointerEl=document.createElement("div"),this.pointerEl.position="absolute",this.pointerEl.display="none",this.projectorEl.appendChild(this.pointerEl),this.containerEl.appendChild(this.projectorEl),this.canvas=document.createElement("canvas"),this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",this.canvasB=document.createElement("canvas"),this.canvasB.style.width="100%",this.canvasB.style.height="100%",this.canvasB.style.position="absolute",this.canvasProjector=document.createElement("canvas"),this.canvasProjector.style.width="100%",this.canvasProjector.style.height="100%",this.canvasProjector.style.position="absolute",this.objectsCanva=document.createElement("div"),this.objectsCanva.style.width="100%",this.objectsCanva.style.height="100%",this.objectsCanva.style.position="absolute",this.foreground=document.createElement("img"),this.foreground.style.position="absolute",this.foreground.style.transformOrigin="0 0",this.foreground.style.webkitTransformOrigin="0 0",this.foreground.style.MozTransformOrigin="0 0",this.foreground.style.msTransformOrigin="0 0",this.foreground.style.OTransformOrigin="0 0",this.crosshairEl=document.createElement("div"),this.crosshairEl.className="crosshair",this.crosshairEl.style.position="absolute",this.crosshairEl.style.transformOrigin="0 0",this.crosshairEl.style.webkitTransformOrigin="0 0",this.crosshairEl.style.MozTransformOrigin="0 0",this.crosshairEl.style.msTransformOrigin="0 0",this.crosshairEl.style.OTransformOrigin="0 0",this.crosshairEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QAQAA9AFN/YZW7AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH4AoTDyESpvZyZAAAANxJREFUWMPtllEKwjAQRF+ipghKFVqhXs/jeAbvIOKpLMUfQVpt4k8LIkULsSxiBvZr2c0wO7sEAgICfh3Hw34t+f4S2Po00F8gsQKMJAElqoAxBuAuReAex3Ep7QErTcAL4z5jbuXuqJ055zSwAG5v+p59HLwDJgBpmgKUjezKOTdSSk2ttVetdQ24RtUoz/O2/gZsfI/Nc8yfIkuSZAdkjVL6JcynG9FnBOc3uVIpVQMXoOrIV4OvYSP7726Blu7hTcBaG/X00iAExkVRiI9A1IQVcPrrL1lAgDceLw8ximVPrtAAAAAASUVORK5CYII=')",this.loadingEl=document.createElement("div"),this.loadingEl.style.position="absolute",this.loadingEl.style.display="flex",this.loadingEl.style.width="100%",this.loadingEl.style.height="100%",this.loadingEl.style.backgroundColor="rgba(255, 255, 255, .4)",this.loadingEl.textContent="...please wait...",this.loadingEl.style.color="#000",this.loadingEl.style.justifyContent="center",this.loadingEl.style.alignItems="center",this.containerEl.style.position="relative",this.containerEl.style.overflow="hidden",this.containerEl.appendChild(this.canvasB),this.containerEl.appendChild(this.objectsCanva),this.containerEl.appendChild(this.canvas),this.containerEl.appendChild(this.canvasProjector),this.watermark&&this.containerEl.appendChild(this.watermark),this.containerEl.appendChild(this.foreground),this.containerEl.appendChild(this.crosshairEl),this.containerEl.appendChild(this.loadingEl),this.width=0,this.height=0,this.windowWidth=0,this.windowHeight=0,this.room=new v(this.token,this),this.away=!1;var a=this;return X.avaliableTools.forEach(function(t){a.registerTool(t.prototype.toolId,t,{})}),this.setTool(X.defaultTool),setTimeout(function(){if(a.clearSketchpad(),a.createEventsDraw(),a.syncNetworkData(),s(),a.syncCanvasFrame(),a.setMetaConfig(t,!1),a.ws.addEventListener("message",function(t){a.receiveMessageFromServer(t)},!0),1===a.ws.readyState?i():a.ws.addEventListener("open",i,!0),a.initialised=!0,a.config.createPageConfig){var e=a.room.addSketch(a,a.config.createPageConfig);a.room.setActiveSketch(a,e)}a.dispatch("initialised",this)},0),this}function v(t,e){
if(!(e instanceof y))throw new Error("Room(room_token, sketchpad)",t,"sketchpad must be instanceof Sketchpad.");return this.sketchpad=e,this.room_token=t,this.sketches=[],this.prevSketch=[],this.totalCount=0,this.clients=[],e.room=this,this}function m(t){return e.call(this,t),this.config=Object.assign({sid:String(Date.now()+Math.random()),cts:Date.now()},t),this.toolsCache=[],this.framesHistory=[],this.newFrames=[],this.myStash=[],this.bulkId=0,this.grindingThreshold=1e3/60,this.userBFramesCounter=0,this.setConfig(this.config),this}function w(t){if(e.call(this,t),!t)return this;if(!(t.sketchpad instanceof y))throw console.warn("config.sketchpad must be instanceof Sketchpad"),new Error("config.sketchpad must be instanceof Sketchpad");this.sketchpad=t.sketchpad,t.toolId&&(this.toolId=t.toolId),t.lineWidth&&(this.lineWidth=t.lineWidth),t.layers&&(this.layers=t.layers),t.color&&(this.color=t.color)}function b(t){w.call(this,t)}function k(t){b.call(this,t)}function x(t){b.call(this,t),this.toolId=t.toolId||"colorpicker",this.layers=[]}function C(t){w.call(this,t)}function E(t){w.call(this,t),this.toolId=t.toolId||"cutout"}function I(t){w.call(this,t)}function A(t){w.call(this,t)}function S(t){w.call(this,t);var e=this;this.emptyImage=document.createElement("img"),this.emptyImage.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAArrAAAK6wGCiw1aAAAAB3RJTUUH4QQJFQY3bU7o3wAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAACR0lEQVR42uWbsU7rMBSG//ObMRkQguVKvAHv/wrsvEGlLiDUIdHd7MNAkHp7AzSJ7WM7lrK0Q+Uv+b6kR4oAeAbwAkCmYw9Lp+PpZtr8X+/9iaTuYfchBHHO3QJ4IQDx3p+cc/c7Oftwzt17708AhACEpKrqq4g8tr55EXlU1dfpahf+I4bqoWUI0+YP55/xvzp8QngYx9G1svFxHJ2IPFxufhYAAAzD8N73/V0rAPq+vxuG4X3uu1kAXdf5Vprw5XzXdf5qAK00Yc75RQBqbcJPzi8GUGMTfnJ+FYCamvCb86sA1NKEa5zfBKDUJixxfjOAEpuwxPkoAEpqwlLnowAopQlrnI8KwKoJW5yPDsCiCVucTwIgZxO2Op8EQK4mxHA+KYBUTYjpfHIAKZoQ0/ksAGI2IbbzWQDEakIK57MCWNuElM5nB7CmCSmdNwGwpAmpnTcBcG0TcjhvCuC7JuR03hzAXBNyOn+5bix+9KwJf6ar4mj1l5rY+TIBcOb8UVWPljNGEwCXzlvOGLMDmLvPW84YabD5g9U8wQzAkvt87hkjLZzPPU8wBbDm2T5nE2jpfOp5ghmAmM/2qZvAEpy3bAJLcN6yCSzJeYsmsDTnczeBJTqfswks0fmcTWDJzudoAkt3PnUTWIPzKZvAGpxP2QTW5HyKJrA252M3gTU6H7MJrNH5mE1gzc7HaAJrd35rE9iC81uawBac39IEtuT8miYQgIYQpBXnr21CCEEAKAGoc+7We/+GnSzv/dv08rQKdv76/Af/G22JqgLBTAAAAABJRU5ErkJggg==";var s=this.sketchpad;document.addEventListener("paste",function(t){if(!e.disabled){var i=t.clipboardData&&t.clipboardData.items||t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items;Object.keys(i).forEach(function(t){var o=i[t];if("file"===o.kind){var r=o.getAsFile();window.tmp=new n({progressParentEl:s.progressParentEl||s.containerEl,file:r}).on("success",function(t){e.onImagehostReady(t.url,0,0,0,0,!0)}).on("error",e.onImagehostError.bind(e))}})}}),this.sketchpad.containerEl.addEventListener("dragover",function(t){e.disabled||t.preventDefault()}),this.sketchpad.containerEl.addEventListener("dragenter",function(t){e.disabled}),this.sketchpad.containerEl.addEventListener("drop",function(t){if(!e.disabled){var i=e.sketchpad.mainPos(t.clientX,t.clientY),o=t.dataTransfer.getData("URL");if(o)return window.tmp=new n({progressParentEl:s.progressParentEl||s.containerEl,url:o}).on("success",function(t){e.onImagehostReady(t.url,i.x,i.y,i.x,i.y)}).on("error",e.onImagehostError.bind(e)),void t.preventDefault();var r=t.dataTransfer.getData("text/html"),a=r.match(/<img.+src\=(?:\"|\')(.+?)(?:\"|\')(?:.+?)>/);if(a&&a[1]){var h=document.createElement("span");return h.innerHTML=a[1],console.log("URL PARSED",encodeURI(h.textContent)),window.tmp=new n({progressParentEl:s.progressParentEl||s.containerEl,url:encodeURI(h.textContent)}).on("success",function(t){e.onImagehostReady(t.url,i.x,i.y,i.x,i.y)}).on("error",e.onImagehostError.bind(e)),void t.preventDefault()}var l=t.dataTransfer.files;if(l.length>0){var c=l[0];return void 0===FileReader||-1===c.type.indexOf("image")&&-1===c.type.indexOf("pdf")||(window.tmp=new n({progressParentEl:s.progressParentEl||s.containerEl,file:c}).on("success",function(t){e.onImagehostReady(t.url,i.x,i.y,i.x,i.y)}).on("error",e.onImagehostError.bind(e))),void t.preventDefault()}}})}function T(t){w.call(this,t),this.toolId=t.toolId||"line"}function P(t){w.call(this,t)}function M(t){w.call(this,t),this.toolId=t.toolId||"move-viewport",this.layers=[]}function D(t){w.call(this,t),this.toolId=t.toolId||"null",this.layers=[]}function O(t){w.call(this,t)}function F(t){w.call(this,t)}function z(t){b.call(this,t)}function L(t){w.call(this,t),this.toolId=t.toolId||"rotate-viewport",this.layers=[]}function B(t){w.call(this,t),this.toolId=t.toolId||"type"}function R(t){function s(t){var e=a.normalize(t.offsetY,0,a.height),s=a.minValue+e/a.height*(a.maxValue-a.minValue);a.setSize(s)}function i(t){a.setSize(a.size-t.deltaY/2),t.preventDefault()}e.call(this,t),"object"!=typeof t.keyModifiers&&(t.keyModifiers={});var r=t.containerEl;this.containerEl=r,r.classList.add("thickness");this.minValue=t.minValue||.01,this.maxValue=t.maxValue||20,this.width=20,this.height=220,this.size=t.size||1,r.style.position="relative",r.style.width="20px",r.style.height="220px",r.style.display="inline-block",this.bgEl=document.createElement("div"),this.bgEl.style.backgroundColor="transparent",this.bgEl.style.position="absolute",this.bgEl.className="bg",this.bgEl.style.top="0px",this.bgEl.style.left="0px",this.bgEl.style.cursor="row-resize",this.bgEl.style.borderLeft="20px solid transparent",this.bgEl.style.borderBottom="220px solid black",this.sliderEl=document.createElement("div"),this.sliderEl.className="slider hue-slider",this.sliderEl.style.width="24px",this.sliderEl.style.height="6.6px",this.sliderEl.style.position="absolute",this.sliderEl.style.top="22px",this.sliderEl.style.left="-2px",this.sliderEl.style.backgroundColor="white",this.sliderEl.style.cursor="row-resize",this.sliderEl.style.boxShadow="inset 0 0 2px #000",this.sliderEl.style.zIndex="100",this.sizeInput=document.createElement("input"),this.sizeInput.title="S:",this.keyshortcuts=new h;var a=this;r.appendChild(this.bgEl),r.appendChild(this.sliderEl),o(this.bgEl,"slide",s),this.bgEl.addEventListener("wheel",i),this.sliderEl.addEventListener("wheel",i),this.keyshortcuts.addShortcut(Object.assign({shiftKey:!1,keyCode:38,repeatable:!0},t.keyModifiers),function(){var t=a.size;t=a.size<=1?Math.round(10*t-1)/10:Math.round(t-1),a.setSize(t)}),this.keyshortcuts.addShortcut(Object.assign({shiftKey:!1,keyCode:40,repeatable:!0},t.keyModifiers),function(){var t=a.size;t=a.size<1?Math.round(10*t+1)/10:Math.round(t+1),a.setSize(t)})}e.prototype={on:function(t,e){return this.registeredCallbacks[t]||(this.registeredCallbacks[t]=[]),this.registeredCallbacks[t].push(e),this},removeListener:function(t,e){if(this.registeredCallbacks[t]){var s;for(s=this.registeredCallbacks[t].length-1;s>=0;s-=1)this.registeredCallbacks[t][s]===e&&this.registeredCallbacks[t].splice(s,1);this.registeredCallbacks[t].indexOf(e)}},once:function(t,e,s){this.registeredCallbacksOnce[t]||(this.registeredCallbacksOnce[t]=[]);var i=!1;return s&&this.registeredCallbacksOnce[t].forEach(function(t){if(t.id===s)return t.fn=e,void(i=!0)}),i||this.registeredCallbacksOnce[t].push({id:s,fn:e}),this},dispatch:function(t,e,s,i){var o=this;return this.registeredCallbacks[t]&&this.registeredCallbacks[t].forEach(function(t){t.call(o,e,s,i)}),this.registeredCallbacksOnce[t]&&(this.registeredCallbacksOnce[t].forEach(function(t){t.fn.call(o,e,s,i)}),delete this.registeredCallbacksOnce[t]),this}},window.Eventsmanager=e,s.prototype=Object.create(e.prototype),Object.assign(s.prototype,{normalize:function(t,e,s){return t<e&&(t=e),t>s&&(t=s),t},pickPalette:function(t,e){t=this.normalize(t,0,100),e=this.normalize(e,0,100),this.color.saturation=t,this.color.value=e;var s=this.HSVtoRGB(this.color.hue,this.color.saturation,this.color.value);this.setPalettePointer(this.color.saturation,this.color.value);var i=s;i.a=this.color.alpha,this.setColor(i)},changeHue:function(t){t%=360,t<0&&(t+=360),this.setHueSlider(t),this.color.hue=t,this.drawPalette(t);var e=this.HSVtoRGB(t,this.color.saturation,this.color.value);e.a=this.color.alpha,this.setColor(e)},changeAlpha:function(t){t=this.normalize(t,0,1),this.color.alpha=t,this.setAlpha(t)},focus:function(){this.isFocused=!0},blur:function(){this.isFocused=!1},getColor:function(){return{red:parseInt(this.color.red,10),green:parseInt(this.color.green,10),blue:parseInt(this.color.blue,10),alpha:parseFloat(this.color.alpha)}},HSVtoRGB:function(t,e,s){var i=e/100,o=s/100,r=i*o,a=t/60,n=r*(1-Math.abs(a%2-1)),h=o-r;return r=255*(r+h),n=255*(n+h),h*=255,a>=0&&a<1?{r:r,g:n,b:h}:a>=1&&a<2?{r:n,g:r,b:h}:a>=2&&a<3?{r:h,g:r,b:n}:a>=3&&a<4?{r:h,g:n,b:r}:a>=4&&a<5?{r:n,g:h,b:r}:a>=5&&a<6?{r:r,g:h,b:n}:{r:0,g:0,b:0}},RGBtoHSV:function(t,e,s){var i=t/255,o=e/255,r=s/255,a=Math.max(i,o,r),n=Math.min(i,o,r),h=a-n,l=0,c=0;h&&(a===i&&(l=(o-r)/h),a===o&&(l=2+(r-i)/h),a===r&&(l=4+(i-o)/h),a&&(c=h/a));var d,p,u;return d=60*l,d<0&&(d+=360),p=100*c,u=100*a,{h:d,s:p,v:u}},putPixel:function(t,e,s,i){var o=4*(e+s*t.width);t.data[o]=i.r,t.data[o+1]=i.g,t.data[o+2]=i.b,t.data[o+3]=i.a},drawHue:function(){var t,e,s;for(t=0;t<this.hueCanvas.width;t+=1)for(e=0;e<this.hueCanvas.height;e+=1)s=this.HSVtoRGB(e/this.hueCanvas.height*360,100,100),this.putPixel(this.hueIData,t,e,{r:s.r,g:s.g,b:s.b,a:255});this.hueContext2d.putImageData(this.hueIData,0,0)},setAlphaSlider:function(t){this.alphaSliderEl.style.left=this.alphaCanvas.width*(t/1)-.015*this.width+"px"},setAlpha:function(t){t=Math.round(100*t)/100,this.color.alpha=t,this.setColor({r:this.color.red,g:this.color.green,b:this.color.blue,a:this.color.alpha})},setHueSlider:function(t){this.hueSliderEl.style.top=this.height*(1/11)+this.hueCanvas.height*(t/360)-.015*this.height+"px"},setPalettePointer:function(t,e){var s=this.paletteCanvas.width*(t/100),i=this.paletteCanvas.height*(e/100);this.palettePointerEl.style.left=.03*-this.width+s+"px",this.palettePointerEl.style.top=.03*-this.height+.1*this.height+i+"px"},triggerUpdate:function(){var t=this.getColor();this.dispatch("change",{color:t})},updateFromInputs:function(){this.setColor({r:this.redInput.value,g:this.greenInput.value,b:this.blueInput.value,a:this.alphaInput.value}),this.setAlpha(this.alphaInput.value)},setColor:function(t,e){var s={h:this.color.hue,s:this.color.saturation,v:this.color.value};(t.r||t.g||t.b)&&(s=this.RGBtoHSV(t.r,t.g,t.b)),t.r===t.g&&t.g===t.b&&(s.h=this.color.hue),this.color.red=t.r,this.color.green=t.g,this.color.blue=t.b,this.color.alpha=t.a,this.color.hue=s.h,this.color.saturation=s.s,this.color.value=s.v,this.redInput.value=t.r,this.greenInput.value=t.g,this.blueInput.value=t.b,this.alphaInput.value=t.a,this.setHueSlider(s.h),this.drawPalette(s.h),this.darwAlpha(t),this.setAlphaSlider(t.a),this.setPalettePointer(s.s,s.v);var i=this.getColor();this.colorEl.style.backgroundColor="rgba("+i.red+","+i.green+","+i.blue+","+i.alpha+")",e||this.triggerUpdate()},drawPalette:function(t){var e,s,i;for(e=0;e<this.paletteCanvas.width;e+=1)for(s=0;s<this.paletteCanvas.height;s+=1)i=this.HSVtoRGB(t,e/this.paletteCanvas.width*100,s/this.paletteCanvas.height*100),this.putPixel(this.paletteIData,e,s,{r:i.r,g:i.g,b:i.b,a:255});this.paletteContext2d.putImageData(this.paletteIData,0,0)},darwAlpha:function(t){var e,s;for(e=0;e<this.alphaCanvas.width;e+=1)for(s=0;s<this.alphaCanvas.height;s+=1)this.putPixel(this.alphaIData,e,s,{r:t.r,g:t.g,b:t.b,a:e/this.alphaCanvas.width*255});this.alphaContext2d.putImageData(this.alphaIData,0,0)}}),window.Colorpalette=s;var Y=!1;try{var j=Object.defineProperty({},"passive",{get:function(){Y=!0}});window.addEventListener("test",null,j)}catch(t){console.log("ignore",t)}window.supportsPassive=Y,window.addEvent=o,r.prototype=Object.create(e.prototype),Object.assign(r.prototype,{normalize:function(t,e,s){return t<e&&(t=e),t>s&&(t=s),t},setSize:function(t){this.size=this.normalize(t,this.minSize,this.maxSize),this.sizeSliderEl.style.left=this.width*(this.size-this.minSize)/(this.maxSize-this.minSize)+"px",this.redrawPreview(),this.dispatch("change",{size:this.size})},setFont:function(t){this.font=t,this.fontListSelectEl.value=t,this.dispatch("change",{font:this.font}),this.redrawPreview()},setColor:function(t){this.color=t,this.redrawPreview()},redrawPreview:function(){var t=this.previewContext2d;t.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height),t.font=this.size+"px "+this.font,t.textAlign="left",t.textBaseline="middle",t.fillStyle="rgba("+this.color.r+","+this.color.g+","+this.color.b+","+this.color.a+")",t.fillText("Lorem ipsum",0,this.previewCanvas.height/2)}}),window.Fontpalette=r,a.prototype=Object.create(e.prototype),Object.assign(a.prototype,{inputs:{},setInputValue:function(t,e){if(this.inputs&&this.inputs[t]&&this.inputs[t].inputEl){var s=this.inputs[t];switch(s.type){case"checkbox":s.inputEl.checked=e;break;default:s.inputEl.value=e}}},addInput:function(t){var e=document.createElement("div");e.style.marginBottom="8px";var s=document.createElement("span");s.style.padding="0",s.style.margin="0",s.style.fontSize="12px",s.style.lineHeight="12px",s.style.display="block",s.textContent=t.title,s.style.marginBottom="2px";var i=document.createElement("input");switch(i.type=t.type||"text",i.name=t.name||"",i.style.width="48px",i.type){case"checkbox":i.style.height="14px",i.style.width="14px",i.style.lineHeight="20px"}i.minValue=t.minValue,i.maxValue=t.maxValue,i.value=t.value,"function"==typeof t.onChange&&i.addEventListener("change",t.onChange),e.appendChild(s),e.appendChild(i),this.containerEl.appendChild(e),this.inputs[i.name]={name:i.name,type:i.type,groupEl:e,labelEl:s,inputEl:i}}}),window.Formpalette=a,n.prototype=Object.create(e.prototype),Object.assign(n.prototype,{isDataURL:function(t){return!!t.match(/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+\=[a-z\-]+)?)?(;base64)?,[a-z0-9\!\$\&\'\,\(\)\*\+\,\;\=\-\.\_\~\:\@\/\?\%\s]*\s*$/i)},dataURItoFile:function(t){if("string"!=typeof t)return void this.dispatch("error",{type:"upload",message:"dataURI must be a string."});t=t.split(",");var e,s=t[0].split(":")[1].split(";")[0],i=atob(t[1]),o=i.length,r=new ArrayBuffer(o),a=new Uint8Array(r);for(e=0;e<o;e+=1)a[e]=i.charCodeAt(e);return new File([a],"file",{type:s})},proxyUrl:function(t){function e(t){setTimeout(function(){i.dispatch("success",{status:"ok",url:t})},0)}var s=document.createElement("a");s.href=t;var i=this;e(-1!==String(s.hostname).indexOf(this.proxyExcludedDomain)?t:this.proxyImageUrl+"?url="+encodeURIComponent(t))},uploadProgress:function(t){this.dispatch("progress",t.loaded/t.total)},uploadFile:function(t){this.File=t,(new FormData).append("fileToUpload",t);var e=new XMLHttpRequest,s=this;e.upload.addEventListener("progress",function(t){s.uploadProgress(t),s.progressbar.uploadProgress(t)},!1),e.addEventListener("load",function(t){console.log("uploading load",t),s.uploadComplete(t),s.progressbar.uploadComplete(t)},!1),e.addEventListener("error",function(t){console.log("uploading error",t),s.uploadFailed(t),s.progressbar.uploadFailed(t)},!1),e.addEventListener("abort",function(t){s.uploadCanceled(t),s.progressbar.uploadCanceled(t)},!1);var i;switch(String(t.type)){case"application/pdf":i=this.postPdfUrl;break;default:i=this.postImageUrl}e.open("POST",i),e.setRequestHeader("Content-Type",t.type),e.setRequestHeader("Content-Name",encodeURI(t.name)),e.setRequestHeader("Content-Size",t.size),e.setRequestHeader("Content-LastModified",t.lastModified),e.send(t),this.dispatch("upload",e)},uploadComplete:function(t){var e={};try{e=JSON.parse(t.target.response)}catch(t){this.dispatch("error",{type:"parse",title:"Upload fail",message:"Uknown response from server.",err:t})}e&&"ok"===e.status?this.dispatch("success",e):this.dispatch("error",{type:"response",title:"Upload fail",message:e&&e.message||"Your upload was rejected by server.",response:e})},uploadFailed:function(t){console.error("uploadFailed",t),this.dispatch("error",{type:"fail",title:"Upload fail",message:"There was an error attempting to upload the file.",e:t})},uploadCanceled:function(t){this.dispatch("error",{type:"cancelled",title:"Upload cancelled",message:"The upload has been canceled by the user or the browser dropped the connection.",e:t})}}),window.Imagehost=n,h.prototype=Object.create(e.prototype),Object.assign(h.prototype,{disabled:!1,disable:function(){"use strct";this.disabled=!0},enable:function(){"use strct";this.disabled=!1},isMac:function(){"use strct";return-1!==navigator.appVersion.indexOf("Mac")},checkIfPressed:function(t,e){return("optional"===t.metaKey||!!t.metaKey==!!e.metaKey)&&(("optional"===t.altKey||!!t.altKey==!!e.altKey)&&(("optional"===t.shiftKey||!!t.shiftKey==!!e.shiftKey)&&(("optional"===t.ctrlKey||!!t.ctrlKey==!!e.ctrlKey)&&t.keyCode===e.keyCode)))},onKeyDown:function(t){if(this.disabled)return!1;var e,s;for(e=0;e<this.shortcuts.length;e+=1)s=this.shortcuts[e],s.pressed&&!s.repeatable||!this.checkIfPressed(s,t)||(s.pressed=!0,"function"==typeof s.callbackDown&&s.callbackDown(t))},onKeyUp:function(t){if(this.disabled)return!1;var e,s;for(e=0;e<this.shortcuts.length;e+=1)s=this.shortcuts[e],s.pressed&&(this.checkIfPressed(s,t),!0)&&(s.pressed=!1,"function"==typeof s.callbackUp&&s.callbackUp(t))},registerEvents:function(){var t=this;window.addEventListener("keydown",function(e){if("INPUT"!==document.activeElement.tagName)return t.onKeyDown(e)}),window.addEventListener("keyup",function(e){if("INPUT"!==document.activeElement.tagName)return t.onKeyUp(e)})},getKeycodeStr:function(t){var e;switch(t){case 32:e="space";break;case 91:e=this.isMac()?"⌘":"WIN";break;case 18:e=this.isMac()?"⌥":"ALT";break;case 16:e=this.isMac()?"⇪":"SHIFT";break;case 17:e=this.isMac()?"ctrl":"CTRL";break;case 27:e="Esc";break;case 20:e=this.isMac()?"⇪":"Caps lock";break;case 13:e="⏎";break;case 8:e="⌫";break;case 187:e="+";break;case 189:e="-";break;default:e=String.fromCharCode(t)}return e},getShortcutStr:function(t){var e=[];return!0===t.metaKey&&e.push(this.isMac()?"⌘":"WIN"),!0===t.altKey&&e.push(this.isMac()?"⌥":"ALT"),!0===t.ctrlKey&&e.push(this.isMac()?"ctrl":"CTRL"),!0===t.shiftKey&&e.push(this.isMac()?"⇪":"SHIFT"),t.keyCode&&e.push(this.getKeycodeStr(t.keyCode)),e.join(" + ")},addShortcut:function(t,e,s){t.callbackDown=e,t.callbackUp=s,this.shortcuts.push(t)}}),window.Keyshortcuts=h,window.randomColor=l;var X={avaliableTools:[],defaultTool:"pen"};window.NSSketchpad=X,c.prototype=Object.create(e.prototype),Object.assign(c.prototype,{normalize:function(t,e,s){return t<e&&(t=e),t>s&&(t=s),t},setPalettePointer:function(t,e){this.x=t,this.y=e,this.palettePointerEl.style.left=.03*-this.width+t+"px",this.palettePointerEl.style.top=.03*-this.height+.1*this.height+e+"px"},pickPalette:function(t,e){console.log("pickPalette",t,e),t=this.normalize(t,0,this.width),e=this.normalize(e,0,this.height);var s=this.paletteContext2d.getImageData(t,e,1,1).data;this.setPalettePointer(t,e);var i={r:s[0],g:s[1],b:s[2],a:s[3]/255};this.setColor(i)},setThresholdSlider:function(t){this.thresholdSliderEl.style.left=this.width*t-.015*this.width+"px"},setThreshold:function(t){t=Math.round(100*t)/100,this.threshold=t,this.setThresholdSlider(t)},changeThreshold:function(t){t=this.normalize(t,0,1),this.threshold=t,this.setThreshold(t)},focus:function(){this.isFocused=!0},blur:function(){this.isFocused=!1},getColor:function(){return{red:parseInt(this.color.red,10),green:parseInt(this.color.green,10),blue:parseInt(this.color.blue,10),alpha:parseFloat(this.color.alpha)}},putPixel:function(t,e,s,i){var o=4*(e+s*t.width);t.data[o]=i.r,t.data[o+1]=i.g,t.data[o+2]=i.b,t.data[o+3]=i.a},triggerUpdate:function(){var t=this.getColor();this.dispatch("change",{color:t})},updateFromInputs:function(){this.setColor({r:this.redInput.value,g:this.greenInput.value,b:this.blueInput.value,a:this.alphaInput.value}),this.setAlpha(this.alphaInput.value)},setColor:function(t,e){this.color.red=t.r,this.color.green=t.g,this.color.blue=t.b,this.color.alpha=t.a,this.redInput.value=t.r,this.greenInput.value=t.g,this.blueInput.value=t.b,this.alphaInput.value=t.a;var s=this.getColor();this.colorEl.style.backgroundColor="rgba("+s.red+","+s.green+","+s.blue+","+s.alpha+")",e||this.triggerUpdate()}}),window.Pixelpicker=c,Array.prototype.findIndex||(Array.prototype.findIndex=function(t){if(null==this)throw new TypeError("Array.prototype.findIndex called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,s=Object(this),i=s.length>>>0,o=arguments[1],r=0;r<i;r++)if(e=s[r],t.call(o,e,r,s))return r;return-1}),function(){var t,e,s,i,o=0,r=["ms","moz","webkit","o"];for(t=0,e=r.length;t<e&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[r[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[r[t]+"CancelAnimationFrame"]||window[r[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,e){return s=(new Date).getTime(),i=Math.max(0,16-(s-o)),o=s+i,window.setTimeout(function(){t(s+i)},i)}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),"function"!=typeof Object.assign&&function(){Object.assign=function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),s=1;s<arguments.length;s++){var i=arguments[s];if(void 0!==i&&null!==i)for(var o in i)i.hasOwnProperty(o)&&(e[o]=i[o])}return e}}(),Array.prototype.find||(Array.prototype.find=function(t){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,s=Object(this),i=s.length>>>0,o=arguments[1],r=0;r<i;r++)if(e=s[r],t.call(o,e,r,s))return e}),d.prototype=Object.create(e.prototype),Object.assign(d.prototype,{prepareLoadingElements:function(){this.id=parseInt(1e3*Math.random(),10),this.loadingBarEl=document.createElement("div");var t=Object.assign({position:"absolute",top:0,left:0,zIndex:200,height:"2px",width:"2px",backgroundColor:"rgba(0, 0, 155, 0.5)",transition:"width 0.4s ease-in-out",webkitTransition:"width 0.4s ease-in-out",MozTransition:"width 0.5s ease-in-out",msTransition:"width 0.5s ease-in-out",OTransition:"width 0.5s ease-in-out"},this.config.style);Object.assign(this.loadingBarEl.style,t),this.config.progressParentEl||(this.config.progressParentEl=window.document.body),this.config.progressParentEl.appendChild(this.loadingBarEl)},uploadProgress:function(t){this.dispatch("progress",t.loaded/t.total),this.loadingBarEl.style.width=parseInt(t.loaded/t.total*100,10)+"%"},uploadCompleteDestructor:function(){this.config.progressParentEl.removeChild(this.loadingBarEl)},uploadComplete:function(){if(this.completed)return void console.log("%cDOUBLED COMPLETE","background-color:orange",this.id);this.completed=!0,this.uploadProgress({loaded:1,total:1}),clearInterval(this.fakeProgressTo),setTimeout(this.uploadCompleteDestructor.bind(this),500)},startFakeProgress:function(){var t=this;t.fakeProgress=0,t.fakeTotal=100,this.fakeProgressTo=setInterval(function(){t.fakeProgress+=.01*(t.fakeTotal-t.fakeProgress),t.uploadProgress({loaded:t.fakeProgress,total:t.fakeTotal})},100)},cancel:function(t){if(this.completed)return void console.log("%DOUBLED CANCEL","background-color:orange",this.id);console.log("%cCANCEL","background-color:orange",this.id,t),clearInterval(this.fakeProgressTo),this.config.progressParentEl.removeChild(this.loadingBarEl),this.completed=!0},uploadCanceled:function(t){this.cancel(t)},uploadFailed:function(t){this.cancel(t)}}),window.Progressbar=d,Object.assign(p.prototype,{getImage:function(t,e,s){function i(t){e(a),h.sketchpad.planRefreshWindow(0,"resources.js:getImage:onImageLoadedOnce")}function o(t){a.loaded=!0,a.success=!0,console.log("on image loaded"),a.loadEvent=t,a.progressbar.uploadComplete(),i(t)}function r(t){if(a.loaded=!0,a.success=!1,a.loadEvent=t,a.progressbar.cancel(),"function"==typeof s)return s(a)}var a,n,h=this;for(n=0;n<this.images.length;n+=1)if(a=this.images[n],a.url===t){if(a.loaded){if(a.success)e(a);else if("function"==typeof s)return s(a)}else a.img.addEventListener("load",i);return}var l=new Image;l.crossOrigin="anonymous";var c=new d({progressParentEl:this.sketchpad.progressParentEl});c.startFakeProgress(),a={url:t,loaded:!1,progressbar:c,img:l},l.src=t,l.addEventListener("load",o),l.addEventListener("error",r),this.images.push(a)}}),window.Resources=p,u.prototype={instance:0,getConfig:function(){return{lay:this.layers.slice(),siz:this.size,col:this.color,fcl:this.fillColor,txt:this.textContent,fnt:this.font,axs:this.axis,tst:1,url:this.url,cen:this.center,mrh:this.mirrorH,mrv:this.mirrorV,mvh:this.mirrorVH,rbw:this.rainbow}},addPoint:function(t,e,s,i){this.sketchpad.readOnly||(e!==this.lastX||s!==this.lastY||i)&&(this.lastT=t-this.timestamp,this.lastX=e,this.lastY=s,this.listT.push(t-this.timestamp),this.listX.push(e),this.listY.push(s))},getLastPoint:function(){return!!this.listX.length&&{x:this.listX[this.listX.length-1],y:this.listY[this.listY.length-1]}},getPointsToSend:function(){var t;if(this.lastSendPointer<this.listX.length-1){var e=this.listT[this.lastSendPointer],s=this.listT.slice(this.lastSendPointer),i=this.listX.slice(this.lastSendPointer),o=this.listY.slice(this.lastSendPointer);for(this.lastSendPointer=this.listX.length-1,t=0;t<s.length;t+=1)s[t]-=e;return{t:s,x:i,y:o}}},getPointsToDraw:function(){if(this.lastDrawPointer<this.listX.length-1){var t=this.listX.slice(this.lastDrawPointer),e=this.listY.slice(this.lastDrawPointer),s=this.listT.slice(this.lastDrawPointer);this.lastDrawPointer=this.listX.length-1;return{t:s,x:t,y:e}}}},window.calculateOffsetXY=g,y.prototype=Object.create(e.prototype),Object.assign(y.prototype,{addSketchPage:function(t,e){function s(o){t.sid===o.getId()&&(i.removeListener("sketch-added",s),"function"==typeof e&&e(o,t))}var i=this;t=Object.assign({sid:"asp"+Math.random()+"h"+(t&&t.backgroundPdf&&t.backgroundPdf.fingerprint)},t),this.sendMessageToServer({cmd:"page",config:t},!1,function(){var e=i.room.addSketch(i,t,"no_autoselect");i.room.setActiveSketch(i,e)}),this.on("sketch-added",s)},getToolsConfigs:function(){var t,e={},s=this;return Object.keys(this.tools).forEach(function(i){var o=s.tools[i];t=o.getToolConfig(),e[t.toolId]=t}),e},setToolsConfigs:function(t){var e=this;Object.keys(this.tools).forEach(function(s){var i=e.tools[s],o=t[s];i&&o&&i.setToolConfig(o)})},setMetaConfig:function(t,e){return console.log("%cSET META CONFIG","background:green",t,e),!this.setMetaConfigFreeze&&(e&&(this.setMetaConfigFreeze=e),t=t||{},this.config=Object.assign(this.config,t),this.token=t.token||"#public",t.password&&(this.password=t.password||""),t.toolsConfigs&&this.setToolsConfigs(t.toolsConfigs),this.syncNetworkDataFrequency=t.syncNetworkDataFrequency||Math.round(1e3),this.centerViewport=!0,this.config.defaultTool&&this.getTool(this.config.defaultTool)&&this.setTool(this.config.defaultTool),this.displayGrid=this.config.features.displayGrid||!1,this.config.features.displayCrosshair?this.crosshairEl.style.display="block":this.crosshairEl.style.display="none",this.config.features.displayViewports?this.hudsEl.style.display="block":this.hudsEl.style.display="none",this.dispatch("setMetaConfig",t,this.setMetaConfigFreeze),this)},setSketchConfig:function(t){t.viewportX=parseFloat(t.viewportX)||0,t.viewportY=parseFloat(t.viewportY)||0,this.setViewportPosition(t.viewportX,t.viewportY),t.viewportScale=parseFloat(t.viewportScale)||1,this.setScale(t.viewportScale),t.viewportZRotation=parseFloat(t.viewportZRotation)||0,this.setRotation(t.viewportZRotation);var e=this;return t.backgroundColor?(this.backgroundColor=t.backgroundColor,this.containerEl.style.backgroundColor=t.backgroundColor):(this.backgroundColor=!1,this.containerEl.style.backgroundColor="transparent"),t.width||(t.width=1024),t.height||(t.height=768),t.backgroundUrl?(this.backgroundUrl=t.backgroundUrl,this.backgroundIFrame.style.display="block",this.backgroundIFrame.width=t.width,this.backgroundIFrame.style.width=t.width+"px",this.backgroundIFrame.height=t.height,this.backgroundIFrame.style.height=t.height+"px",this.backgroundIFrame.src=t.backgroundUrl,this.backgroundIFrame.crossOrigin="anonymous"):(this.backgroundIFrame.src="about:blank",this.backgroundUrl=!1,this.backgroundIFrame.style.display="none"),t.backgroundImage?(this.backgroundImage=t.backgroundImage,this.background.style.display="none",this.background.onload=function(){e.background.style.display="block",console.log("ON LOAD!"),e.planRefreshWindow(0,"sketchpad.js:setSketchConfig:background.onload"),e.backgroundImageProgressbar.uploadComplete()},this.background.onerror=function(){e.backgroundImageProgressbar.cancel()},this.backgroundImageProgressbar&&!this.backgroundImageProgressbar.completed&&this.backgroundImageProgressbar.cancel(),this.background.onerror=function(){e.backgroundImageProgressbar.cancel()},this.backgroundImageProgressbar=new d({progressParentEl:this.progressParentEl}),this.backgroundImageProgressbar.startFakeProgress(),this.background.src=t.backgroundImage.toString(),this.background.crossOrigin="anonymous"):(this.background.src="",this.backgroundImage=!1,this.background.style.display="none"),t.foregroundImage?(this.foregroundImage=t.foregroundImage,this.foreground.style.display="none",this.foreground.onload=function(){e.foreground.style.display="block",e.planRefreshWindow(0,"sketchpad.js:setSketchConfig:foreground.onload"),e.foregroundImageProgressbar.uploadComplete()},this.foreground.onerror=function(){e.foregroundImageProgressbar.cancel()},this.foregroundImageProgressbar&&!this.foregroundImageProgressbar.completed&&this.foregroundImageProgressbar.cancel(),this.foregroundImageProgressbar=new d({progressParentEl:this.progressParentEl}),this.foregroundImageProgressbar.startFakeProgress(),this.foreground.src=t.foregroundImage.toString(),this.foreground.crossOrigin="anonymous"):(this.foreground.src="",this.foregroundImage=!1,this.foreground.style.display="none"),this.planRefreshWindow(0,"sketchpad.js:setSketchConfig"),this.dispatch("setPageConfig",t),this},getRoomConfig:function(){var t={};return t.token=this.token,t.password=this.password,t.currentSketchSid=this.room.sketch&&this.room.sketch.getId()||"getRoomConfig-empty-sketch",t.toolsConfigs=this.getToolsConfigs(),t.defaultTool=this.tool,t.toolbar=this.config.toolbar,t.features=this.config.features,t},getSketchConfig:function(){var t={};return t.viewportX=parseFloat(this.viewportX)||0,t.viewportY=parseFloat(this.viewportY)||0,t.viewportScale=parseFloat(this.scale)||1,t.viewportZRotation=parseFloat(this.rotation)||0,this.config.backgroundType&&(t.backgroundType=this.config.backgroundType),this.config.backgroundColorR&&(t.backgroundColorR=this.config.backgroundColorR),this.config.backgroundColorG&&(t.backgroundColorG=this.config.backgroundColorG),this.config.backgroundColorB&&(t.backgroundColorB=this.config.backgroundColorB),this.config.backgroundColorR&&(t.backgroundColorA=this.config.backgroundColorA),this.config.backgroundMapsLocation&&(t.backgroundMapsLocation=this.config.backgroundMapsLocation),this.config.backgroundPdf&&(t.backgroundPdf=this.config.backgroundPdf),this.config.backgroundMapsType&&(t.backgroundMapsType=this.config.backgroundMapsType),this.config.backgroundMapsZoom&&(t.backgroundMapsZoom=this.config.backgroundMapsZoom),this.backgroundColor&&(t.backgroundColor=this.backgroundColor),this.backgroundImage&&(t.backgroundImage=this.backgroundImage),this.backgroundUrl&&(t.backgroundUrl=this.backgroundUrl),this.foregroundImage&&(t.foregroundImage=this.foregroundImage),t},saveSketchpad:function(t){var e=[],s=this.getRoomConfig();t||(s.password=""),e.push({hello:"Visit site www.sketchpad.pro to open this file.",site:"http://sketchpad.pro",description:"Sketchpad room file",cmd:"meta",config:s});var i;for(i=0;i<this.room.sketches.length;i+=1)e.push(this.room.sketches[i].getPageConfig(this)),e=e.concat(this.room.sketches[i].getFrames())
;return e},colorPicker:function(t,e){var s=document.createElement("canvas");s.width=1,s.height=1;var i=s.getContext("2d");this.backgroundColor&&(i.fillStyle=this.backgroundColor,i.fillRect(0,0,s.width,s.height)),i.translate(-this.width/2-t,-this.height/2-e),this.background&&this.background.width&&(i.save(),i.translate(this.width/2,this.height/2),i.rotate(this.rotation*Math.PI/180),i.scale(this.scale,this.scale),i.translate(-this.viewportX,-this.viewportY),i.drawImage(this.background,-this.background.width/2,-this.background.height/2),i.restore()),i.drawImage(this.canvasB,0,0),i.drawImage(this.canvas,0,0),this.foreground&&this.foreground.width&&(i.save(),i.translate(this.width/2,this.height/2),i.rotate(this.rotation*Math.PI/180),i.scale(this.scale,this.scale),i.translate(-this.viewportX,-this.viewportY),i.drawImage(this.foreground,-this.foreground.width/2,-this.foreground.height/2),i.restore()),this.watermark&&i.drawImage(this.watermark,this.width-this.watermark.width,this.height-this.watermark.height);var o=i.getImageData(0,0,1,1).data;return{r:o[0],g:o[1],b:o[2],a:o[3]/255}},renderOutputCanvas:function(t){var e=document.createElement("canvas"),s=this.viewportX,i=this.viewportY,o=this.width,r=this.height,a=this.rotation,n=this.scale;e.width=o,e.height=r;var h=e.getContext("2d");return t&&(this.backgroundColor&&"transparent"!==this.backgroundColor||(this.backgroundColor=t)),this.backgroundColor&&(h.fillStyle=this.backgroundColor,h.fillRect(0,0,e.width,e.height)),this.backgroundCanvas&&h.drawImage(this.backgroundCanvas,0,0),this.background&&this.background.width&&(h.save(),h.translate(o/2,r/2),h.rotate(a*Math.PI/180),h.scale(n,n),h.translate(-s,-i),h.drawImage(this.background,-this.background.width/2,-this.background.height/2),h.restore()),h.drawImage(this.canvasB,0,0),h.drawImage(this.canvas,0,0),this.foreground&&this.foreground.width&&(h.save(),h.translate(o/2,r/2),h.rotate(a*Math.PI/180),h.scale(n,n),h.translate(-s,-i),h.drawImage(this.foreground,-this.foreground.width/2,-this.foreground.height/2),h.restore()),this.watermark&&h.drawImage(this.watermark,o-this.watermark.width,r-this.watermark.height),e},screenshot:function(t,e,s){return this.renderOutputCanvas().toBlob(t,e,s)},toDataURL:function(t,e){var s=!1;return"image/jpeg"===e&&(s="white"),this.renderOutputCanvas(s).toDataURL(t,e)},showGrid:function(t){function e(t,e,s,i,r){o.beginPath(),o.strokeStyle=r,o.moveTo(t,e),o.lineTo(s,i),o.stroke()}function s(t,s){e(0,t,r.width,t,s)}function i(t,s){e(t,0,t,r.height,s)}var o=this.contextProjector2D;if(!o)return!1;var r=this;this.displayGrid=!0,t=t||{};var a=t.step||100,n=t.substep||10;o.save(),s(this.height/2,"rgba(0,0,0,0.1)"),i(this.width/2,"rgba(0,0,0,0.1)");var h,l;for(h=this.width/2;h<=this.width;h+=a)i(h,"rgba(255,0,0,0.2)");for(h=this.width/2;h>0;h-=a)i(h,"rgba(255,0,0,0.2)");for(h=this.width/2;h<=this.width;h+=n)i(h,"rgba(255,0,0,0.1)");for(h=this.width/2;h>0;h-=n)i(h,"rgba(255,0,0,0.1)");for(l=this.height/2;l<=this.height;l+=a)s(l,"rgba(255,0,0,0.2)");for(l=this.height/2;l>0;l-=a)s(l,"rgba(255,0,0,0.2)");for(l=this.height/2;l<=this.height;l+=n)s(l,"rgba(255,0,0,0.1)");for(l=this.height/2;l>0;l-=n)s(l,"rgba(255,0,0,0.1)");o.restore()},hideGrid:function(){this.displayGrid=!1,this.contextProjector2D.clearRect(0,0,this.width,this.height)},clearSketchpad:function(){this.windowWidth=this.containerEl.clientWidth,this.windowHeight=this.containerEl.clientHeight,this.backgroundCanvas.width=this.windowWidth,this.backgroundCanvas.height=this.windowHeight,this.canvas.width=this.windowWidth,this.canvas.height=this.windowHeight,this.width=this.canvas.width,this.height=this.canvas.height,this.canvasB.width=this.windowWidth,this.canvasB.height=this.windowHeight,this.canvasProjector.width=this.windowWidth,this.canvasProjector.height=this.windowHeight,this.context2D=this.canvas.getContext("2d"),this.contextB2D=this.canvasB.getContext("2d"),this.contextProjector2D=this.canvasProjector.getContext("2d"),this.context2D.lineCap="round",this.context2D.lineJoin="round",this.contextB2D.lineCap="round",this.contextProjector2D.lineJoin="round",this.contextProjector2D.lineCap="round",this.contextProjector2D.lineJoin="round",this.objectsCanva.innerHTML="",this.context2D.setTransform(1,0,0,1,0,0),this.contextB2D.clearRect(0,0,this.width,this.height),this.centerViewport&&(this.context2D.translate(this.width/2,this.height/2),this.contextB2D.translate(this.width/2,this.height/2));var t,e,s,i;this.displayGrid&&this.showGrid(),this.backgroundIFrame&&(this.centerViewport?(t=this.width/2-this.backgroundIFrame.width/2,e=this.height/2-this.backgroundIFrame.height/2,s=this.width/2,i=this.height/2,this.backgroundIFrame.style.transformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.webkitTransformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.MozTransformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.msTransformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.OTransformOrigin=s+"px "+i+"px",this.backgroundIFrame.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.backgroundIFrame.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.backgroundIFrame.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.backgroundIFrame.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.backgroundIFrame.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)"):(this.backgroundIFrame.style.transform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.webkitTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.MozTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.msTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.OTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")")),this.background&&(this.centerViewport?(t=this.width/2-this.background.width/2,e=this.height/2-this.background.height/2,s=this.width/2,i=this.height/2,this.background.style.transformOrigin=s+"px "+i+"px",this.background.style.webkitTransformOrigin=s+"px "+i+"px",this.background.style.MozTransformOrigin=s+"px "+i+"px",this.background.style.msTransformOrigin=s+"px "+i+"px",this.background.style.OTransformOrigin=s+"px "+i+"px",this.background.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.background.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.background.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.background.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.background.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)"):(this.background.style.transform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.webkitTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.MozTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.msTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.OTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")")),this.foreground&&(this.centerViewport?(t=this.width/2-this.foreground.width/2,e=this.height/2-this.foreground.height/2,s=this.width/2,i=this.height/2,this.foreground.style.transformOrigin=s+"px "+i+"px",this.foreground.style.webkitTransformOrigin=s+"px "+i+"px",this.foreground.style.MozTransformOrigin=s+"px "+i+"px",this.foreground.style.msTransformOrigin=s+"px "+i+"px",this.foreground.style.OTransformOrigin=s+"px "+i+"px",this.foreground.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.foreground.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.foreground.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.foreground.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)",this.foreground.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+t+"px, "+e+"px)"):(this.foreground.style.transform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.webkitTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.MozTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.msTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.OTransform="translate("+1*-this.viewportX+"px, "+1*-this.viewportY+"px) scale("+1*this.scale+")")),this.hudsEl.style.transformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.webkitTransformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.MozTransformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.msTransformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.OTransformOrigin=this.width/2+"px "+this.height/2+"px",this.hudsEl.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)",this.hudsEl.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)",this.hudsEl.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)",this.hudsEl.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)",this.hudsEl.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)"},refreshWindow:function(t){function e(t,a){if(i===s.postponeDrawingVersion&&o===s.room.sketch){var n;for(n=a;n<t.length&&n<a+r;n+=1)s.drawSketchFrame(t[n].evs,s.room.sketch);n<t.length&&setTimeout(function(){e(t,n)},0)}}if(this.initialised&&!this.receivingHistory){this.sendInputs(),this.drawInputs();var s=this,i=String(Date.now()),o=this.room.sketch;this.postponeDrawingVersion=i;var r=100;if(this.room&&this.room.sketch instanceof m){this.room.sketch.framesHistory.length>1024?(this.loadingEl.style.display="flex",this.loadingEl.textContent="..."):this.loadingEl.style.display="none",s.clearSketchpad();e(s.room.sketch.getCommandsHist(),0),s.loadingEl.style.display="none",s.dispatch("changeViewport"),s.dispatch("refreshWindow")}}},planRefreshWindow:function(t,e){t=parseInt(t)||0,this.planRefreshWindowTo&&clearTimeout(this.planRefreshWindowTo);var s=this;this.planRefreshWindowTo=setTimeout(function(){s.refreshWindow(e)},t)},setViewportPosition:function(t,e,s){t=parseFloat(t),e=parseFloat(e);var i={deltaX:t-this.viewportX,deltaY:e-this.viewportY};this.viewportX=t,this.viewportY=e;var o=this;return this.once("refreshWindow",function(){o.dispatch("setViewportPosition",i),s||o.sendCurrentViewport()},"setViewportPosition:sendCurrentViewport"),this.planRefreshWindow(0,"sketchpad.js:setViewportPosition"),this},moveViewportRelative:function(t,e){var s=-this.rotation,i={x:t*(1/this.scale),y:e*(1/this.scale)};return s=2*Math.PI*(s/360),i={x:Math.cos(s)*i.x-Math.sin(s)*i.y,y:Math.sin(s)*i.x+Math.cos(s)*i.y},this.setViewportPosition(this.viewportX-i.x,this.viewportY-i.y),this},setScale:function(t){return t=parseFloat(t),t||(t=1),this.scale=t,this.setViewportPosition(this.viewportX,this.viewportY),this},setRotation:function(t){return t%=360,t<0&&(t+=360),this.rotation=t,this.setViewportPosition(this.viewportX,this.viewportY),this.dispatch("setRotation",{o:t}),this},registerTool:function(t,e,s){function i(){this===r.getCurrentTool()&&r.user&&r.user.user_id&&r.projectPointer(r.pointerX,r.pointerY)}"object"!=typeof s&&(s={}),s.toolId=t,s.sketchpad=this;var o=new e(s);this.tools[o.toolId]=o;var r=this;o.on("changeParams",i),this.config&&this.config.registerToolCb&&"function"==typeof this.config.registerToolCb&&this.config.registerToolCb(o)},getCurrentTool:function(){return this.getTool(this.tool)},getCurrentToolId:function(){return this.tool},getTool:function(t){return t?this.tools[t]:this.getCurrentTool()},drawSketchNewFrames:function(){if(this.room.sketch instanceof m&&this.room){var t,e=this.room.sketch.getCommandsCurrent();for(t=0;t<e.length;t+=1)this.drawSketchFrame(e[t].evs,this.room.sketch)}},reset:function(t){if(this.room.reset(),!t){var e={cmd:"reset",ts:(new Date).getTime()};this.sendMessageToServer(e)}this.dispatch("reset"),this.planRefreshWindow(0,"sketchpad.js:reset")},canDraw:function(){return!this.readOnly},clearCanvas:function(){this.inputs={},this.context2D.clearRect(0,0,this.canvas.width,this.canvas.height),this.contextB2D.clearRect(0,0,this.canvas.width,this.canvas.height)},setTool:function(t,e){if(this.getTool(t)){var s=this.tool!==t,i=this.tool;return this.tool=t,this.dispatch("setTool",{hasChanged:s,lastToolId:i,tool:this.getTool(t),extra:e}),this}},drawFramePath:function(t,e){if(this.drawingPaused)return void this.pausedQueue.push({config:t,points:e});if(e.x.length>0){var s=this.getTool(t.tol);s?s.drawFramePath(t,e):console.warn("sketchpad.js","Unknown tool",t)}},drawFrame:function(t){var e;for(e=0;e<t.length;e+=1)this.drawFramePath(t[e],t[e].pts)},pauseDrawing:function(){this.drawingPaused=!0},resumeDrawing:function(){var t;this.drawingPaused=!1;var e=this.pausedQueue;for(this.pausedQueue=[],t=0;t<e.length;t+=1)this.drawFramePath(e[t].config,e[t].points)},drawInputs:function(){var t,e,s,i=[],o=this;Object.keys(this.inputs).forEach(function(r){(t=o.inputs[r])&&(e=t.getPointsToDraw())&&(s={},s.tol=t.tool,s.cnf=t.getConfig(),s.vpx=t.viewportX,s.vpy=t.viewportY,s.scl=t.scale,s.rot=t.rotation,s.wdh=t.width,s.hgt=t.height,s.pts=e,s.uid=t.UID,i.push(s))}),i.length>0&&this.drawFrame(i)},drawSketchFrame:function(t,e){var s,i;for(s=0;s<t.length;s+=1)void 0!==t[s].cid&&(i=e.getCachedFrame(t[s].cid)),this.drawFramePath(i,t[s].pts)},startPath:function(t,e,s,i){if(this.inputs[e])return!1;var o=this.getCurrentToolId(),r=this.getTool(o),a=r.startInput(e,s,i,t);this.inputs[e]=a,this.dispatch("startPath",a)},drawPath:function(t,e,s,i){if(!this.inputs[e])return!1;this.getTool(this.inputs[e].tool).moveInput(this.inputs[e],s,i,t)},endPath:function(t,e,s,i){if(!this.inputs[e])return!1;this.getTool(this.inputs[e].tool).finishInput(this.inputs[e],s,i,t),this.sendInputs(),this.drawInputs(),delete this.inputs[e]},syncCanvasFrame:function(){var t=this;this.windowWidth===this.containerEl.clientWidth&&this.windowHeight===this.containerEl.clientHeight||(this.windowWidth=this.containerEl.clientWidth,this.windowHeight=this.containerEl.clientHeight,this.once("refreshWindow",function(){t.sendCurrentViewport()},"syncCanvasFrame:sendCurrentViewport:(resize)"),this.planRefreshWindow(1e3,"room.js:syncCanvasFrame:(resize)")),this.receivingHistory&&(this.loadingEl.textContent=this.receivingHistoryInputsLoaded+"/"+this.receivingHistoryInputsTotal),window.requestAnimationFrame(function(){t.syncCanvasFrame()}),this.drawSketchNewFrames(),this.drawInputs()},mainPos:function(t,e){var s=g(this.containerEl,t,e);return this.centerViewport&&(s.x=s.x-this.width/2,s.y=s.y-this.height/2),s},projectPointer:function(t,e){var s=this.getTool(),i=s.getCursor(),o=this.pointerEl;this.pointerEl.style.display="block",i&&i.pointer&&(this.containerEl.style.cursor=i.pointer),this.containerEl.style.cursor=i.pointer,Object.assign(o.style,i),o.style.position="absolute",o.style.left=t+"px",o.style.top=e+"px"},pointerMove:function(t,e){this.pointerX=parseInt(t+this.width/2,10),this.pointerY=parseInt(e+this.height/2,10),this.projectPointer(this.pointerX,this.pointerY)},createEventsDraw:function(){var t=this.containerEl,e=this;t.addEventListener("mousedown",function(t){if(e.inputEventsDisabled)return!1;t.preventDefault(),e.mouseLB=!0;var s=e.mainPos(t.clientX,t.clientY);e.startPath(t,0,s.x,s.y)},!1),t.addEventListener("mousemove",function(t){if(e.inputEventsDisabled)return!1;var s=e.mainPos(t.clientX,t.clientY);e.pointerMove(s.x,s.y),t.preventDefault(),e.mouseLB&&e.drawPath(t,0,s.x,s.y)},!1),t.addEventListener("mouseup",function(t){if(e.inputEventsDisabled)return!1;t.preventDefault(),e.mouseLB=!1;var s=e.mainPos(t.clientX,t.clientY);e.endPath(t,0,s.x,s.y)},!1),t.addEventListener("mouseleave",function(t){if(e.inputEventsDisabled||!e.mouseLB)return!1;t.preventDefault(),e.mouseLB=!1;var s=e.mainPos(t.clientX,t.clientY);e.endPath(t,0,s.x,s.y)},!1),t.addEventListener("contextmenu",function(t){if(e.inputEventsDisabled||!e.mouseLB)return!1;e.mouseLB=!1;var s=e.mainPos(t.clientX,t.clientY);e.endPath(t,0,s.x,s.y)},!1),t.addEventListener("touchstart",function(t){if(e.inputEventsDisabled)return!1;t.preventDefault();var s,i;for(s=0;s<t.changedTouches.length;s+=1)i=e.mainPos(t.changedTouches[s].clientX,t.changedTouches[s].clientY),e.startPath(t,t.changedTouches[s].identifier+10,i.x,i.y)},!1),t.addEventListener("touchmove",function(t){if(e.inputEventsDisabled)return!1;t.preventDefault();var s,i;for(s=0;s<t.changedTouches.length;s+=1)i=e.mainPos(t.changedTouches[s].clientX,t.changedTouches[s].clientY),e.drawPath(t,t.changedTouches[s].identifier+10,i.x,i.y)},!1),t.addEventListener("touchend",function(t){if(e.inputEventsDisabled)return!1;t.preventDefault();var s,i;for(s=0;s<t.changedTouches.length;s+=1)i=e.mainPos(t.changedTouches[s].clientX,t.changedTouches[s].clientY),e.endPath(t,t.changedTouches[s].identifier+10,i.x,i.y)},!1)},disableInputEvents:function(){this.inputEventsDisabled=!0},enableInputEvents:function(){this.inputEventsDisabled=!1},openConnection:function(t,e){console.info("sketchpad.js","[info] openConnection",e)},getCurrentViewport:function(){return{sid:this.room.sketch&&this.room.sketch.getId()||"getCurrentViewport-init",x:this.viewportX,y:this.viewportY,width:this.width,height:this.height,scale:this.scale,rotation:this.rotation,away:this.away}},sendCurrentViewport:function(){if(this.room.sketch instanceof m){var t={cmd:"update-viewport",user:{user_id:this.user&&this.user.user_id||this.UID,color:this.COLOR,viewport:this.getCurrentViewport()}};this.sendMessageToServer(t),this.room.updateClient(t.user),this.dispatch("updateClient",t.user)}},undo:function(){this.room.sketch.undo(this)},redo:function(){this.room.sketch.redo(this)},sendStringToServer:function(t,e,s){if(1!==this.ws.readyState)return"function"==typeof s&&s("offline"),"ignore";try{this.ws.send(t),"function"==typeof e&&e()}catch(e){console.error("Error sending ws message",e,t),"function"==typeof s&&s(e)}},sendMessageToServer:function(t,e,s){var i=JSON.stringify(t);return this.sendStringToServer(i,e,s)},executeInputCommand:function(t){var e,s;switch(t.cmd){case"ping":this.sendMessageToServer({cmd:"pong",requestNo:t.no,requestTs:t.ts});break;case"goto":t.position&&(t.position.pageNo&&(e=this.room.getSketchByNo(t.position.pageNo))&&this.room.setActiveSketch(this,e),void 0!==t.position.x&&void 0!==t.position.y&&this.setViewportPosition(t.position.x,t.position.y),t.position.scale&&this.setScale(t.position.scale),t.position.rotation&&this.setRotation(t.position.rotation));break;case"room-status":this.editorsCount=t.editorsCount,this.viewersCount=t.viewersCount,this.dispatch("changeRoomStatus");break;case"set-permissions":t.permissions?(this.readOnly=!t.permissions.canDraw,this.dispatch("set-permissions",t.permissions)):console.error("Received not valid permissions in set-permission response");break;case"meta":t.config?this.setMetaConfig(t.config,"freeze"):console.error("Received not valid config in meta response");break;case"page":t.config?e=this.room.setPageConfig(this,t.config):console.error("Received not valid page config in page response");break;case"remove-page":t.sid&&(e=this.room.getSketchBySid(t.sid)),e instanceof m?this.room.removeSketch(this,e,"remoteRemove"):console.warn("cannot remove sketch by input sid","[",t.sid,"]");break;case"clear-page":t.sid&&(e=this.room.getSketchBySid(t.sid)),e instanceof m?(e.reset(this,e,"remoteClear"),this.dispatch("sketch-cleared",e),this.planRefreshWindow(0,"sketchpad.js:executeInputCommand:clear-page")):console.warn("cannot clear sketch by input sid","[",t.sid,"]");break;case"history-begin":this.receivingHistory=!0,this.loadingEl.style.display="flex",this.receivingHistoryInputsTotal=t.inputsCount||t.messagesCount||"?",this.receivingHistoryInputsLoaded=0,this.loadingEl.textContent=this.receivingHistoryInputsLoaded+"/"+this.receivingHistoryInputsTotal;break;case"netspeed-begin":this.room.sketch.grindingThreshold=1e3;break;case"inputs":t.sid&&(e=this.room.getSketchBySid(t.sid)),e instanceof m||(console.warn("cannot find sketch by input sid, creating new sketch","[",t.sid,"]"),e=this.room.addSketch(this,Object.assign(this.getSketchConfig(),{sid:t.sid}),"remoteSketch"),this.room.sketch||this.room.setActiveSketch(this,e)),this.receivingHistory&&(this.receivingHistoryInputsLoaded+=1),e!==this.room.sketch&&(s=this.receivingHistory,this.receivingHistory=!0),e.grindBulkFrame(this,t,this.receivingHistory),e!==this.room.sketch&&(this.receivingHistory=s);break;case"history-end":this.receivingHistory=!1,this.loadingEl.style.display="none",this.planRefreshWindow(0,"sketchpad.js:executeInputCommand:history-end");break;case"netspeed-end":this.room.sketch.grindingThreshold=1e3/60;break;case"init-begin":this.initialised=!1;break;case"init-end":this.initialised=!0,this.config.currentPageNo||(this.config.currentPageNo=1),e=this.room.getSketchByNo(this.config.currentPageNo),e||(this.config.currentPageNo=1,e=this.room.getSketchByNo(this.config.currentPageNo)),e&&this.room.setActiveSketch(this,e),this.dispatch("initialised");break;case"reset":this.reset("remote");break;case"user-hello":t.user&&t.user.user_id&&t.user.viewport?(t.user.user_id=String(t.user.user_id),this.room.addClient(t.user),this.dispatch("addClient",t.user)):console.error("dropping user-hello, wrong  ``user || user.user_id``");break;case"pointer-move":t.user_id?this.room.setViewportPointer(t.user_id,t.x,t.y):console.error("dropping pointer-move, wrong ``user_id``");break;case"update-viewport":t.user&&t.user.user_id&&t.user.viewport?(t.user.user_id=String(t.user.user_id),this.room.updateClient(t.user),this.dispatch("updateClient",t.user)):console.error("dropping user-viewport, wrong  ``user || user.user_id``");break;case"user-bye":t.user&&t.user.user_id?(t.user.user_id=String(t.user.user_id),this.room.removeClientById(t.user.user_id),this.dispatch("removeClient",t.user)):console.error("dropping user-bye, wrong  ``user || user.user_id``");break;case"undo":t&&t.uid&&t.sid&&(e=this.room.getSketchBySid(t.sid),e instanceof m?e.undoSketch(this,t.uid):console.error("sketch not exists",t.sid,t),e===this.room.sketch&&this.planRefreshWindow(0,"sketchpad.js:executeInputCommand:undo"));break;case"you":t&&t.user&&(this.user=t.user,this.dispatch("identify",t.user));break;default:this.dispatch("customMessageFromServer",t)}},receiveMessageFromServer:function(t){var e=JSON.parse(t.data),s=this;e&&setTimeout(function(){s.executeInputCommand(e)},0)},sendInputs:function(){if(this.room&&this.room.sketch){var t,e,s,i={cmd:"inputs",sid:this.room.sketch.getId(),ts:(new Date).getTime(),uid:this.UID,evs:[]},o=this;if(Object.keys(this.inputs).forEach(function(r){(e=o.inputs[r])&&666!==r&&(s=e.getPointsToSend())&&(t={},t.tol=e.tool,t.cnf=e.getConfig(),t.vpx=e.viewportX,t.vpy=e.viewportY,t.scl=e.scale,t.rot=e.rotation,t.wdh=e.width,t.hgt=e.height,t.pts=s,t.uid=e.UID,i.evs.push(t))}),i.evs.length>0){this.sendMessageToServer(i);this.room.sketch.grindBulkFrame(this,i,!0)}}},syncNetworkData:function(){this.syncNetworkDataTimeout&&clearTimeout(this.syncNetworkDataTimeout),this.syncNetworkDataTimeout=0;var t=this;this.syncNetworkDataTimeout=setTimeout(function(){t.syncNetworkData()},this.syncNetworkDataFrequency),this.sendInputs()}}),v.prototype={reset:function(){var t;for(t=this.sketches.length-1;t>=0;t-=1)this.sketches[t].destructor(),this.sketches.splice(t,1);this.sketch=void 0},getSketchBySid:function(t){var e;for(e=0;e<this.sketches.length;e+=1)if(this.sketches[e].getId()===t)return this.sketches[e];return!1},getSketchByNo:function(t){var e=parseInt(t,10)-1;return this.sketches[e]},getCurrentSketchNo:function(){return this.sketches.indexOf(this.sketch)+1},addSketch:function(t,e){if(t.sendInputs(),t.drawInputs(),this.totalCount+=1,!e)throw new Error("Room.addSketch - config param is required");e=Object.assign({titleNo:this.totalCount},e);var s=new m(e);return this.sketches.push(s),t.dispatch("sketch-added",s),s},setPageConfig:function(t,e){var s;return e.sid&&(s=this.getSketchBySid(e.sid)),s?(this.sketch===s&&this.sketch.setConfig(t.getSketchConfig()),s.setConfig(e),this.sketch===s&&t.setSketchConfig(s.getConfig()),t.dispatch("sketch-changed",s)):s=this.addSketch(t,e,"remoteFlag"),this.sketch||this.setActiveSketch(t,s),s},setActiveSketch:function(t,e){if(!(e instanceof m))return void console.error("sketchpad.room.js","setActiveSketch(sketchpad, sketch) - sketch instanceof Sketch is required");t.sendInputs(),t.drawInputs(),this.sketch&&(this.sketch.setConfig(t.getSketchConfig()),this.prevSketch.push(this.sketch)),this.sketch=e,t.setSketchConfig(e.getConfig()),t.dispatch("sketch-changed",e),t.dispatch("historySketch-status",e.getHistoryStatus()),t.planRefreshWindow(0,"room.js:setActiveSketch")},removeSketch:function(t,e,s){if(!s&&!t.canDraw())return void console.error("Insufficient permissions to perform `removeSketch` operation");if(!(e instanceof m))throw new Error("sketchpad.room.js:removeSketch(sketchpad, sketch, remoteRemoveFlag), sketch must be instanceof Sketch");t.sendInputs(),t.drawInputs();var i;for(i=this.prevSketch.length-1;i>=0;i-=1)this.prevSketch[i]===e&&this.prevSketch.splice(i,1);for(i=this.sketches.length-1;i>=0;i-=1)this.sketches[i]===e&&this.sketches.splice(i,1);this.sketch===e&&(this.prevSketch.length>0?(this.sketch=this.prevSketch.pop(),t.setSketchConfig(this.sketch.getConfig()),t.dispatch("sketch-changed",this.sketch)):this.sketches.length>0?(this.sketch=this.sketches[0],t.dispatch("sketch-changed",this.sketch),t.setSketchConfig(this.sketch.getConfig())):(this.sketch=null,t.setSketchConfig({}))),t.dispatch("sketch-removed",e),s||t.sendMessageToServer({cmd:"remove-page",sid:e.getId()}),t.planRefreshWindow(0,"room.js:removeSketch")},addClient:function(t){"use strct";var e=t.user_color||{r:Math.round(25+205*Math.random()),g:Math.round(25+205*Math.random()),b:Math.round(25+205*Math.random())},s=document.createElement("div"),i=document.createElement("div"),o=document.createElement("div");o.style.display="none",o.style.backgroundColor="rgba("+e.r+", "+e.g+", "+e.b+", 0.5)",o.style.position="absolute",o.style.borderRadius="50%",o.style.marginLeft="-5px",o.style.marginTop="-5px",o.style.width="10px",o.style.height="10px",i.className="username",i.textContent="New ID: "+t.user_id,i.style.backgroundColor="rgba("+e.r+", "+e.g+", "+e.b+", 1)",i.style.color="#FFF",i.style.fontSize="12px",s.appendChild(o),s.appendChild(i),s.className="viewport",s.style.position="absolute",s.style.overflow="hidden",s.style.border="1px solid rgba("+e.r+", "+e.g+", "+e.b+", 1)",s.style.boxSizing="border-box",t.pointerEl=o,t.viewportEl=s,this.setViewport(s,t,this.sketchpad),this.sketchpad.hudsEl.appendChild(t.viewportEl),this.clients.push(t),this.redrawViewports()},setViewportPointer:function(t,e,s){var i=this.getClientById(t);i&&(i.pointerEl.style.display="block",i.pointerEl.style.left=e+"px",i.pointerEl.style.top=s+"px")},setViewport:function(t,e,s){if(this.sketch instanceof m){var i=e.viewport;i.sid!==s.room.sketch.getId()?t.style.display="none":t.style.display="block",e.user_id===s.user.user_id&&(t.style.border="none",t.style.zIndex=2),t.querySelector(".username").textContent=(e.viewport.away?"[Away]":"")+" "+e.user_name,t.style.top="0px",t.style.left="0px",t.style.width=i.width+"px",t.style.height=i.height+"px",t.style.transformOrigin=i.x+"px "+i.y+"px",t.style.webkitTransformOrigin=i.x+"px "+i.y+"px",t.style.MozTransformOrigin=i.x+"px "+i.y+"px",t.style.msTransformOrigin=i.x+"px "+i.y+"px",t.style.OTransformOrigin=i.x+"px "+i.y+"px";var o="translate("+s.width/2+"px,"+s.height/2+"px) scale("+1/i.scale+") rotate("+-1*i.rotation+"deg) translate("+i.x+"px, "+i.y+"px) translate("+-i.width/2+"px, "+-i.height/2+"px)";t.style.transform=o,t.style.webkitTransform=o,t.style.MozTransform=o,t.style.msTransform=o,t.style.OTransform=o}},redrawViewports:function(){var t=this;this.clients.forEach(function(e){t.setViewport(e.viewportEl,e,t.sketchpad)})},updateClient:function(t){var e,s;for(e=0;e<this.clients.length;e+=1)s=this.clients[e],s.user_id===t.user_id&&(s.webrtc=t.webrtc,s.viewport=t.viewport);this.redrawViewports()},getClientById:function(t){var e,s;for(e=this.clients.length-1;e>=0;e-=1)if(s=this.clients[e],String(s.user_id)===String(t))return s},removeClientById:function(t){console.warn("Removing user",t);var e,s,i=this;for(e=this.clients.length-1;e>=0;e-=1)s=this.clients[e],String(s.user_id)===String(t)&&(i.sketchpad.hudsEl.removeChild(s.viewportEl),this.clients.splice(e,1))}},m.prototype=Object.create(e.prototype),Object.assign(m.prototype,{getHistoryStatus:function(){return{undo:this.userBFramesCounter,redo:this.myStash.length}},getId:function(){return String(this.config.sid)},setConfig:function(t){this.config=Object.assign(this.config,t)},getConfig:function(){return this.config},getPageConfig:function(t){return this===t.room.sketch&&this.setConfig(t.getSketchConfig()),{description:"Drawing board sketch page",version:"0.5.1",timestamp:Date.now(),timestampISO:(new Date).toISOString(),host:document.location.host,cmd:"page",config:this.getConfig()}},getFrames:function(){var t,e,s=this.framesHistory.concat(this.newFrames);for(t=0;t<s.length;t+=1)for(e=0;e<s[t].evs.length;e+=1)void 0!==s[t].evs[e].cid&&Object.assign(s[t].evs[e],this.getCachedFrame(s[t].evs[e].cid)),s[t].cmd="inputs",s[t].sid=this.getId();return s},cacheFrame:function(t){var e=this.toolsCache.findIndex(function(e){return!!e&&(e.tol===t.tol&&e.vpx===t.vpx&&e.vpy===t.vpy&&e.scl===t.scl&&e.rot===t.rot&&e.hgt===t.hgt&&e.wdh===t.wdh&&JSON.stringify(e.cnf)===JSON.stringify(t.cnf))});return-1===e?(this.toolsCache.push({vpx:t.vpx,vpy:t.vpy,scl:t.scl,rot:t.rot,tol:t.tol,hgt:t.hgt,wdh:t.wdh,cnf:t.cnf}),this.toolsCache.length-1):e},
getCachedFrame:function(t){return this.toolsCache[t]},reset:function(){this.toolsCache=[],this.myStash=[],this.framesHistory=[],this.newFrames=[],this.grindingThreshold=1e3/60},grindBulkFrame:function(t,e,s){var i,o,r,a,n,h=this;if(this.bulkId+=1,t.UID===e.uid&&(this.userBFramesCounter||t.dispatch("undoAvaliable"),this.userBFramesCounter+=1),e.evs&&e.evs.length)for(;e.evs.length;){for(r=e.evs[0].pts.t[0],o=r+this.grindingThreshold,i={uid:e.uid,bid:this.bulkId,evs:[]},a=e.evs.length-1;a>=0;a-=1)e.evs[a].pts.t.length>1&&(n=function(t,e){for(var s,i=0;t.pts.t[i]<=e;)i+=1;i<2&&(i=2),s={cid:h.cacheFrame(t),pts:{t:t.pts.t.splice(0,i),x:t.pts.x.splice(0,i),y:t.pts.y.splice(0,i)}};var o=s.pts.t[s.pts.t.length-1],r=s.pts.x[s.pts.x.length-1],a=s.pts.y[s.pts.y.length-1];return t.pts.t.unshift(o),t.pts.x.unshift(r),t.pts.y.unshift(a),s}(e.evs[a],o),i.evs.push(n)),e.evs[a].pts.t.length<2&&e.evs.splice(a,1);s?this.framesHistory.push(i):this.newFrames.push(i)}},getCommandsHist:function(){return this.framesHistory},getCommandsCurrent:function(){var t,e=this.newFrames.splice(0,1);if(e.length){for(t=0;t<e.length;t+=1)this.framesHistory.push(e[t]);return e}return[]},undoSketch:function(t,e){function s(t,e,s){var r,a,n=t.length;for(n-=1;n>-1;n-=1)if(!s&&t[n].uid===e||t[n].uid===e&&t[n].bid===s){for(r=t.splice(n,1)[0],s=r.bid,a=0;a<r.evs.length;a+=1)void 0!==r.evs[a].cid&&Object.assign(r.evs[a],o.getCachedFrame(r.evs[a].cid));i.push(r)}}var i=[],o=this;return s(this.newFrames,e,!1),s(this.framesHistory,e,!1),t.UID===e&&i.length&&(this.userBFramesCounter-=1,0===this.userBFramesCounter&&t.dispatch("undoUnavaliable")),i},sendUndo:function(t){t.sendMessageToServer({sid:this.getId(),cmd:"undo",uid:t.UID,user:{user_id:t.UID}})},undo:function(t){t.sendInputs();var e=this.undoSketch(t,t.UID);this.sendUndo(t),t.planRefreshWindow(0,"undo"),this.myStash=this.myStash.concat(e),this.myStash.length>0&&t.dispatch("redoAvaliable")},redo:function(t){if(this.myStash&&this.myStash.length>0){if(!this.myStash.length)return void console.warn("Redo stash empty!");var e=this.myStash.splice(-1)[0],s={uid:t.UID,ts:(new Date).getTime(),cmd:"inputs",evs:e.evs};t.sendMessageToServer(s),this.grindBulkFrame(t,e),0===this.myStash.length&&t.dispatch("redoUnavaliable")}else t.dispatch("redoUnavaliable")},destructor:function(){this.reset()}}),w.prototype=Object.create(e.prototype),w.prototype=Object.assign(w.prototype,{sketchpad:"error: undefined sketchpad object",layers:["F"],toolLabel:"Default tool",toolId:"default_tool_class",lineWidth:1,minSize:.1,maxSize:100,maxLayers:1,color:{r:0,g:0,b:0,a:1},getCursor:function(){var t=parseInt(this.getSize()+1,10);return{pointer:"crosshair",marginLeft:-t/2+"px",marginTop:-t/2+"px",width:t+"px",height:t+"px",border:"1px solid black",boxSizing:"border-box",borderRadius:"50%",backgroundColor:"rgba(0,0,0,0)"}},getToolConfig:function(){return{toolId:this.toolId,layers:this.layers,lineWidth:this.lineWidth,maxLayers:this.maxLayers,color:this.getColorStr()}},setToolConfig:function(t){Array.isArray(t.layers)&&(this.layers=t.layers);var e,s;if(t.color)switch(typeof t.color){case"string":e=String(t.color).match(/([0-9]+),([0-9]+),([0-9]+),([0-9\.]+)/),s={r:parseInt(e&&e[1])||0,g:parseInt(e&&e[2])||0,b:parseInt(e&&e[3])||0,a:parseFloat(e&&e[4])||0},this.setColor(s.r,s.g,s.b,s.a);break;case"object":this.setColor(t.color.r,t.color.g,t.color.b,t.color.a)}return parseFloat(t.lineWidth)&&this.setSize(parseFloat(t.lineWidth)),this.dispatch("changeParams"),this},distance:function(t,e,s,i){return Math.sqrt(Math.pow(Math.abs(t-s),2)+Math.pow(Math.abs(e-i),2))},rotate:function(t,e){return t=2*Math.PI*(t/360),e={x:Math.cos(t)*e.x-Math.sin(t)*e.y,y:Math.sin(t)*e.x+Math.cos(t)*e.y}},setColor:function(t,e,s,i){return void 0===i&&(i=this.color.a),this.color={r:t,g:e,b:s,a:i},this.dispatch("changeParams"),this},getColor:function(){return this.color},getColorStr:function(){return"rgba("+this.color.r+","+this.color.g+","+this.color.b+","+this.color.a+")"},setSize:function(t){return this.lineWidth=parseFloat(t),this.dispatch("changeParams"),this},getSize:function(){return this.lineWidth},startInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new u({sketchpad:o,id:t,tool:this.toolId,layers:this.layers,color:this.getColorStr(),size:this.lineWidth});return r.addPoint((new Date).getTime(),e,s),r.addPoint((new Date).getTime(),e,s,"force"),r},moveInput:function(t,e,s,i){if(i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),i&&i.shiftKey){var o=t.getLastPoint();if(o&&(Math.abs(o.x-e)<10&&(e=o.x),Math.abs(o.y-s)<10&&(s=o.y),o.x===e&&o.y===s))return!1}t.addPoint((new Date).getTime(),e,s,i)},finishInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),t.addPoint((new Date).getTime(),e,s)},drawFramePath:function(t,e){var s,i,o,r=this.sketchpad,a=t.cnf;if(!a.lay||!a.lay.length)return void console.warn("no layers to draw");for(o=0;o<a.lay.length;o+=1){switch(a.lay[o]){case r.LAYER_BACK:s=r.contextB2D;break;case r.LAYER_FRONT:s=r.context2D;break;default:s=r.context2D}if(s.save(),s.rotate(r.rotation*Math.PI/180),s.scale(r.scale,r.scale),s.translate(t.vpx,t.vpy),s.translate(-r.viewportX,-r.viewportY),s.scale(1/t.scl,1/t.scl),s.rotate(-t.rot*Math.PI/180),e&&e.x&&e.x.length>1){for(s.beginPath(),s.lineCap="round",s.lineJoin="round",s.strokeStyle=a.col,s.lineWidth=a.siz,s.moveTo(e.x[0],e.y[0]),i=1;i<e.x.length;i+=1)s.lineTo(e.x[i],e.y[i]);s.stroke()}s.restore()}}}),X.avaliableTools.push(w),b.prototype=Object.create(w.prototype),Object.assign(b.prototype,{toolLabel:"_fillable class",toolId:"_fillable class",fillColor:{r:128,g:0,b:128,a:.1},getToolConfig:function(){var t=w.prototype.getToolConfig.call(this);return Object.assign(t,{fillColor:this.getFillColorStr()})},setToolConfig:function(t){w.prototype.setToolConfig.call(this,t);var e,s;if(t.fillColor)switch(typeof t.fillColor){case"string":e=String(t.fillColor).match(/([0-9]+),([0-9]+),([0-9]+),([0-9\.]+)/),s={r:parseInt(e&&e[1])||0,g:parseInt(e&&e[2])||0,b:parseInt(e&&e[3])||0,a:parseFloat(e&&e[4])||0},this.setFillColor(s.r,s.g,s.b,s.a);break;case"object":this.setFillColor(t.fillColor.r,t.fillColor.g,t.fillColor.b,t.fillColor.a)}return this.dispatch("changeParams"),this},setFillColor:function(t,e,s,i){return void 0===i&&(i=this.fillColor.a),this.fillColor={r:t,g:e,b:s,a:i},this.dispatch("changeParams"),this},getFillColor:function(){return this.fillColor},getFillColorStr:function(){return"rgba("+this.fillColor.r+","+this.fillColor.g+","+this.fillColor.b+","+this.fillColor.a+")"}}),k.prototype=Object.create(b.prototype),Object.assign(k.prototype,{lineWidth:1,toolLabel:"Circle",layers:["F"],toolId:"circle",keyCode:67,color:{r:0,g:0,b:0,a:1},fillColor:{r:255,g:127,b:0,a:0},startInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new u({sketchpad:o,id:t,tool:this.toolId,color:this.getColorStr(),fillColor:this.getFillColorStr(),size:this.lineWidth,layers:this.layers,uid:this.sketchpad.UID});return r.firstX=e,r.firstY=s,r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.border="1px solid white",r.selectorDiv.style.borderRadius="50%",r.selectorDiv.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e-1+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s-1+"px"):(r.selectorDiv.style.left=e-1+"px",r.selectorDiv.style.top=s-1+"px"),r.selectorDiv.style.width="1px",r.selectorDiv.style.height="1px",r.selectorDiv2=document.createElement("div"),r.selectorDiv2.style.position="absolute",r.selectorDiv2.style.border="1px dashed black",r.selectorDiv2.style.borderRadius="50%",r.selectorDiv2.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv2.style.left=this.sketchpad.width/2+e-1+"px",r.selectorDiv2.style.top=this.sketchpad.height/2+s-1+"px"):(r.selectorDiv2.style.left=e-1+"px",r.selectorDiv2.style.top=s-1+"px"),r.selectorDiv2.style.width="1px",r.selectorDiv2.style.height="1px",o.containerEl.appendChild(r.selectorDiv),o.containerEl.appendChild(r.selectorDiv2),r.addPoint((new Date).getTime(),e,s),r},moveInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.firstX,r=t.firstY,a=Math.abs(e-o),n=Math.abs(s-r);i.shiftKey&&(a=n),this.sketchpad.centerViewport?(t.selectorDiv.style.left=this.sketchpad.width/2+o-a+"px",t.selectorDiv.style.top=this.sketchpad.height/2+r-n+"px",t.selectorDiv2.style.left=this.sketchpad.width/2+o-a+"px",t.selectorDiv2.style.top=this.sketchpad.height/2+r-n+"px"):(t.selectorDiv.style.left=o-a+"px",t.selectorDiv.style.top=r-n+"px",t.selectorDiv2.style.left=o-a+"px",t.selectorDiv2.style.top=r-n+"px"),t.selectorDiv.style.width=2*a+"px",t.selectorDiv.style.height=2*n+"px",t.selectorDiv2.style.width=2*a+"px",t.selectorDiv2.style.height=2*n+"px"},finishInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=t.firstX,a=t.firstY,n=Math.abs(s-a);i.shiftKey&&(e=r+n),t.addPoint((new Date).getTime(),e,s),o.containerEl.removeChild(t.selectorDiv),o.containerEl.removeChild(t.selectorDiv2)},recalcS:function(t,e){var s=this.sketchpad;return e*=1/t.scl,e*=s.scale},drawFramePath:function(t,e){var s,i,o,r=t.cnf,a=this.sketchpad;if(!r.lay||!r.lay.length)return void console.warn("no layers to draw");var n,h;for(s=0;s<r.lay.length;s+=1){switch(r.lay[s]){case a.LAYER_BACK:o=a.contextB2D;break;case a.LAYER_FRONT:o=a.context2D;break;default:o=a.context2D}o.save(),o.rotate(a.rotation*Math.PI/180),o.scale(a.scale,a.scale),o.translate(t.vpx,t.vpy),o.translate(-a.viewportX,-a.viewportY),o.scale(1/t.scl,1/t.scl),o.rotate(-t.rot*Math.PI/180),n={x:e.x[0],y:e.y[0]},h={x:e.x[1],y:e.y[1]},o.translate(n.x,n.y),o.beginPath(),o.scale(1,Math.abs(h.y-n.y)/Math.abs(h.x-n.x)),i=Math.abs(h.x-n.x),o.arc(0,0,i,0,2*Math.PI,!1),o.restore(),o.strokeStyle=r.col,o.fillStyle=r.fcl,o.lineWidth=this.recalcS(t,r.siz),o.fill(),o.stroke(),o.restore()}}}),X.avaliableTools.push(k),x.prototype=Object.create(b.prototype),Object.assign(x.prototype,{maxLayers:0,keyCode:73,toolLabel:"Colorpicker",toolId:"colorpicker",color:{r:128,g:128,b:128,a:0},getCursor:function(){return{pointer:"none",marginLeft:"-5px",marginTop:"-5px",width:"10px",height:"10px",borderRadius:"50%",border:"1px solid black",backgroundColor:this.getColorStr()}},startInput:function(t,e,s,i){var o=this.sketchpad,r=new u({sketchpad:o,id:t,tool:this.toolId}),a=this.sketchpad.colorPicker(e,s);return i.shiftKey||2===i.button?(this.fillColorChanged=!0,this.setFillColor(a.r,a.g,a.b,a.a)):(this.colorChanged=!0,this.setColor(a.r,a.g,a.b,a.a)),r.tmpCursor=this.sketchpad.containerEl.style.cursor,o.containerEl.style.cursor="crosshair",r},moveInput:function(t,e,s,i){var o=this.sketchpad.colorPicker(e,s);return 2===i.button&&(i.preventDefault(),i.stopPropagation()),i.shiftKey||2===i.button?(this.fillColorChanged=!0,this.setFillColor(o.r,o.g,o.b,o.a)):(this.colorChanged=!0,this.setColor(o.r,o.g,o.b,o.a)),t},finishInput:function(t,e,s,i){var o=this.sketchpad.colorPicker(e,s);return 2===i.button&&(i.preventDefault(),i.stopPropagation()),i.shiftKey||2===i.button?(this.fillColorChanged=!0,this.setFillColor(o.r,o.g,o.b,o.a)):(this.colorChanged=!0,this.setColor(o.r,o.g,o.b,o.a)),this.sketchpad.containerEl.style.cursor=t.tmpCursor,t},drawFramePath:function(){}}),X.avaliableTools.push(x),C.prototype=Object.create(w.prototype),Object.assign(C.prototype,{toolId:"custom",lineWidth:10,keyCode:88,toolLabel:"Custom tool",drawFramePath:function(t,e){var s,i,o,r=t.cnf,a=this.sketchpad;if(o=null,!r.lay||!r.lay.length)return void console.warn("no layers to draw");var n,h;for(i=0;i<r.lay.length;i+=1){switch(r.lay[i]){case a.LAYER_BACK:o=a.contextB2D;break;case a.LAYER_FRONT:o=a.context2D;break;default:o=a.context2D}if(o.save(),o.rotate(a.rotation*Math.PI/180),o.scale(a.scale,a.scale),o.translate(t.vpx,t.vpy),o.translate(-a.viewportX,-a.viewportY),o.scale(1/t.scl,1/t.scl),o.rotate(-t.rot*Math.PI/180),e&&e.x&&e.y&&e.x.length>1)for(s=1;s<e.x.length;s+=1)n={x:e.x[s-1],y:e.y[s-1]},h={x:e.x[s],y:e.y[s]},o.beginPath(),o.strokeStyle=this.getColorStr(),o.lineCap="miter",o.lineJoin="miter",o.lineWidth=r.siz+100/(10+this.distance(n.x,n.y,h.x,h.y)),o.moveTo(n.x,n.y),o.lineTo(h.x,h.y),o.stroke();o.restore()}}}),X.avaliableTools.push(C),E.prototype=Object.create(w.prototype),Object.assign(E.prototype,{maxLayers:"*",toolId:"cutout",layers:["F","B"],toolLabel:"Cut-out",getCursor:function(){return{pointer:"crosshair",borderRadius:0,backgroundColor:"rgba(0,0,0,0)",border:"none"}},startInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new u({sketchpad:o,id:t,tool:this.toolId,layers:this.layers});return r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.border="1px solid #f00",r.selectorDiv.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s+"px"):(r.selectorDiv.style.left=e+"px",r.selectorDiv.style.top=s+"px"),r.selectorDiv.style.width="1px",r.selectorDiv.style.height="1px",r.selectorDiv.style.background="#f88",r.selectorDiv.style.opacity="0.3",o.containerEl.appendChild(r.selectorDiv),r.addPoint((new Date).getTime(),e,s),r},moveInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.listX[0],r=t.listY[0],a=Math.min(o,e),n=Math.min(r,s),h=Math.max(o,e),l=Math.max(r,s);this.sketchpad.centerViewport?(t.selectorDiv.style.left=this.sketchpad.width/2+a+"px",t.selectorDiv.style.top=this.sketchpad.height/2+n+"px"):(t.selectorDiv.style.left=a+"px",t.selectorDiv.style.top=n+"px"),t.selectorDiv.style.width=h-a+"px",t.selectorDiv.style.height=l-n+"px"},finishInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad;t.addPoint((new Date).getTime(),e,s),o.containerEl.removeChild(t.selectorDiv)},drawFramePath:function(t,e){var s,i=t.cnf,o=this.sketchpad;if(!i.lay||!i.lay.length)return void console.warn("no layers to draw");var r;for(s=0;s<i.lay.length;s+=1){switch(i.lay[s]){case o.LAYER_BACK:r=o.contextB2D;break;case o.LAYER_FRONT:r=o.context2D}r.save(),r.rotate(o.rotation*Math.PI/180),r.scale(o.scale,o.scale),r.translate(t.vpx,t.vpy),r.translate(-o.viewportX,-o.viewportY),r.scale(1/t.scl,1/t.scl),r.rotate(-t.rot*Math.PI/180),r.clearRect(e.x[0],e.y[0],e.x[1]-e.x[0],e.y[1]-e.y[0]),r.restore()}}}),X.avaliableTools.push(E),I.prototype=Object.create(w.prototype),Object.assign(I.prototype,{toolId:"eraser",maxLayers:"*",layers:["F","B"],lineWidth:16,minSize:2,maxSize:200,toolLabel:"Eraser",getCursor:function(){var t=parseInt(this.getSize()+1,10);return{pointer:"crosshair",marginLeft:-t/2+"px",marginTop:-t/2+"px",width:t+"px",height:t+"px",border:"1px solid black",boxSizing:"border-box",borderRadius:"50%",backgroundColor:"rgba(255,255,255,.5)"}},drawFramePath:function(t,e){var s,i,o,r=t.cnf,a=this.sketchpad;if(o=null,!r.lay||!r.lay.length)return void console.warn("no layers to draw");var n,h;for(i=0;i<r.lay.length;i+=1){switch(r.lay[i]){case a.LAYER_BACK:o=a.contextB2D;break;case a.LAYER_FRONT:o=a.context2D}if(o.save(),o.globalCompositeOperation="destination-out",o.rotate(a.rotation*Math.PI/180),o.scale(a.scale,a.scale),o.translate(t.vpx,t.vpy),o.translate(-a.viewportX,-a.viewportY),o.scale(1/t.scl,1/t.scl),o.rotate(-t.rot*Math.PI/180),e&&e.x&&e.y&&e.x.length>1)for(s=1;s<e.x.length;s+=1)n={x:e.x[s-1],y:e.y[s-1]},h={x:e.x[s],y:e.y[s]},o.beginPath(),o.strokeStyle=this.getColorStr(n.x,n.y),o.lineCap="miter",o.lineJoin="miter",o.lineWidth=r.siz,o.moveTo(n.x,n.y),o.lineTo(h.x,h.y),o.stroke();o.restore()}}}),X.avaliableTools.push(I),A.prototype=Object.create(w.prototype),Object.assign(A.prototype,{toolId:"highlighter",color:{r:255,g:255,b:15,a:.5},layers:["B"],lineWidth:16,keyCode:72,toolLabel:"Highlighter",getCursor:function(){var t=parseInt(this.getSize(),10);return t=t/2+t/(t/5+0),{pointer:"none",marginLeft:-t/2+"px",marginTop:-t/2+"px",width:t+"px",height:t+"px",border:"none",borderRadius:0,backgroundColor:this.getColorStr()}},drawFramePath:function(t,e){var s,i,o,r,a,n=this.sketchpad,h=t.cnf;if(!h.lay||!h.lay.length)return void console.warn("no layers to draw");for(o=0;o<h.lay.length;o+=1){switch(h.lay[o]){case n.LAYER_BACK:s=n.contextB2D;break;case n.LAYER_FRONT:s=n.context2D;break;default:s=n.context2D}if(s.save(),s.lineCap="butt",s.lineJoin="round",s.rotate(n.rotation*Math.PI/180),s.scale(n.scale,n.scale),s.translate(t.vpx,t.vpy),s.translate(-n.viewportX,-n.viewportY),s.scale(1/t.scl,1/t.scl),s.rotate(-t.rot*Math.PI/180),s.strokeStyle=h.col,s.lineWidth=h.siz,e&&e.x&&e.x.length>1)for(i=1;i<e.x.length;i+=1)r={x:e.x[i-1],y:e.y[i-1]},a={x:e.x[i],y:e.y[i]},s.beginPath(),s.lineWidth=h.siz/2+h.siz/(h.siz/5+this.distance(r.x,r.y,a.x,a.y)/10),s.moveTo(r.x,r.y),s.lineTo(a.x,a.y),s.stroke();s.restore()}}}),X.avaliableTools.push(A),S.prototype=Object.create(w.prototype),Object.assign(S.prototype,{layers:["F"],toolLabel:"Image",toolId:"image",keyCode:79,disabled:!1,fieldThreshold:100,disable:function(){this.disabled=!0},enable:function(){this.disabled=!1},getCursor:function(){return{pointer:"crosshair",backgroundColor:"rgba(0,0,0,0)",borderRadius:"0",border:"none"}},onImagehostError:function(t){popnotifications.notification(t.title,t.message)},onImagehostReady:function(t,e,s,i,o,r){var a=new u({sketchpad:this.sketchpad,id:777,tool:this.toolId,layers:this.layers,url:t,center:r});this.sketchpad.inputs[777]=a,a.addPoint((new Date).getTime(),e,s),a.addPoint((new Date).getTime(),i,o,"force"),this.sketchpad.sendInputs(),this.sketchpad.drawInputs(),delete this.sketchpad.inputs[777]},startInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new u({sketchpad:o,id:t,tool:this.toolId,layers:this.layers});return r.firstX=e,r.firstY=s,r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.border="1px solid black",r.selectorDiv.style.outline="1px dashed white",r.selectorDiv.style.outlineOffset="-1px",r.selectorDiv.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s+"px"):(r.selectorDiv.style.left=e+"px",r.selectorDiv.style.top=s+"px"),r.selectorDiv.style.width="1px",r.selectorDiv.style.height="1px",o.containerEl.appendChild(r.selectorDiv),r},moveInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.firstX,r=t.firstY;Math.abs(o-e)<this.fieldThreshold||Math.abs(r-s)<this.fieldThreshold?Math.abs(o-e)<Math.abs(r-s)?(t.selectorDiv.style.background="linear-gradient(to right, rgba(0,0,0,.2), transparent)",t.selectorDiv.style.border="1px dashed #888",t.selectorDiv.style.boxSizing="border-box",t.selectorDiv.style.borderRight="",t.selectorDiv.style.outline="",e=o+100):(t.selectorDiv.style.background="linear-gradient(to bottom, rgba(0,0,0,.2), transparent)",t.selectorDiv.style.border="1px dashed #888",t.selectorDiv.style.boxSizing="border-box",t.selectorDiv.style.borderBottom="",t.selectorDiv.style.outline="",s=r+100):(t.selectorDiv.style.outline="1px dashed white",t.selectorDiv.style.border="1px solid black",t.selectorDiv.style.boxSizing="",t.selectorDiv.style.background="",t.selectorDiv.style.filter="");var a=Math.abs(s-r);i.shiftKey&&(e=e<o?o-a:o+a);var n=Math.min(o,e),h=Math.min(r,s),l=Math.max(o,e);a=Math.max(r,s)-h;var c=l-n;this.sketchpad.centerViewport?(t.selectorDiv.style.left=this.sketchpad.width/2+n-1+"px",t.selectorDiv.style.top=this.sketchpad.height/2+h-1+"px"):(t.selectorDiv.style.left=n+"px",t.selectorDiv.style.top=h+"px"),t.selectorDiv.style.width=c+"px",t.selectorDiv.style.height=a+"px"},finishInput:function(t,e,s,i){function o(t){d.onImagehostReady(t.url,a,h,e,s)}i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var r=this.sketchpad,a=t.firstX,h=t.firstY;(Math.abs(a-e)<this.fieldThreshold||Math.abs(h-s)<this.fieldThreshold)&&(Math.abs(a-e)<Math.abs(h-s)?e=a:s=h);var l=Math.abs(s-h);i.shiftKey&&(e=e<a?a-l:a+l);var c=document.createElement("input");c.type="file",c.style.position="fixed",c.style.display="none",c.accept=".jpg,.jpeg,.png,.gif,.svg,image/*;capture=camera",c.click();var d=this;c.addEventListener("change",function(t){var e,s,i=t.target.files;for(e=0;e<i.length;e+=1)s=i[e],window.tmp=new n({progressParentEl:r.progressParentEl||r.containerEl,file:s}).on("success",o).on("error",d.onImagehostError.bind(d))}),r.containerEl.removeChild(t.selectorDiv)},drawFramePath:function(t,e){function s(s){for(i=0;i<r.lay.length;i+=1){switch(r.lay[i]){case a.LAYER_BACK:o=a.contextB2D;break;case a.LAYER_FRONT:o=a.context2D;break;default:o=a.context2D}o.save(),o.beginPath(),o.rotate(a.rotation*Math.PI/180),o.scale(a.scale,a.scale),o.translate(t.vpx,t.vpy),o.translate(-a.viewportX,-a.viewportY),o.scale(1/t.scl,1/t.scl),o.rotate(-t.rot*Math.PI/180),n={x:Math.min(e.x[0],e.x[1]),y:Math.min(e.y[0],e.y[1])},h={x:Math.max(e.x[0],e.x[1]),y:Math.max(e.y[0],e.y[1])},l=h.x-n.x,c=h.y-n.y,l<1&&c<1&&(l=s.width,c=s.height),l<1&&(l=s.width*(c/s.height)),c<1&&(c=s.height*(l/s.width)),r.cen&&(n.x-=s.width/2,n.y-=s.height/2),o.drawImage(s,n.x,n.y,l,c),o.restore()}}var i,o,r=t.cnf,a=this.sketchpad;if(!r||!r.lay||!r.lay.length)return void console.warn("no layers to draw");var n,h,l,c,d=this;r.url?a.resources.getImage(r.url,function(t){t.success&&s(t.img)},function(t){console.warn("error loading image",r.url,t),d.emptyImage.complete&&d.emptyImage.naturalWidth?s(d.emptyImage):d.emptyImage.addEventListener("load",function(){s(d.emptyImage)})}):console.log("error url")}}),X.avaliableTools.push(S),T.prototype=Object.create(w.prototype),Object.assign(T.prototype,{color:{r:0,g:0,b:0,a:1},toolLabel:"Line",toolKey:"l",toolId:"line",lineWidth:1,keyCode:76,startInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new u({sketchpad:o,id:t,tool:this.toolId,color:this.getColorStr(),size:this.lineWidth,layers:this.layers});r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.display="block",r.selectorDiv.style.backgroundColor=this.getColorStr(),this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s+"px"):(r.selectorDiv.style.left=e+"px",r.selectorDiv.style.top=s+"px"),r.selectorDiv.style.width="1px";var a=this.getSize();return a<1&&(r.selectorDiv.style.borderTop="1px dashed "+this.getColorStr()),r.selectorDiv.style.height=a+"px",r.startX=e,r.startY=s,o.containerEl.appendChild(r.selectorDiv),r.addPoint((new Date).getTime(),e,s),r},connect:function(t,e,s,i,o,r){var a=Math.sqrt((i-e)*(i-e)+(o-s)*(o-s)),n=(e+i)/2-a/2,h=(s+o)/2-r/2,l=Math.atan2(s-o,e-i)*(180/Math.PI);this.sketchpad.centerViewport?(t.style.left=this.sketchpad.width/2+n+"px",t.style.top=this.sketchpad.height/2+h+"px"):(t.style.left=n+"px",t.style.top=h+"px"),t.style.width=a+"px",t.style.transform="rotate("+l+"deg)",t.style.webkitTransform="rotate("+l+"deg)",t.style.MozTransform="rotate("+l+"deg)",t.style.msTransform="rotate("+l+"deg)",t.style.OTransform="rotate("+l+"deg)"},moveInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.startX,r=t.startY;if(i.shiftKey){var a=e-o,n=s-r,h=this.distance(o,r,e,s),l=Math.round(Math.atan2(a,n)/(Math.PI/4))*(Math.PI/4);e=o+h*Math.sin(l),s=r+h*Math.cos(l)}var c=o,d=r,p=e,u=s;this.connect(t.selectorDiv,c,d,p,u,this.getSize())},finishInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=t.startX,a=t.startY;if(i.shiftKey){var n=e-r,h=s-a,l=this.distance(r,a,e,s),c=Math.round(Math.atan2(n,h)/(Math.PI/4))*(Math.PI/4);e=r+l*Math.sin(c),s=a+l*Math.cos(c)}t.addPoint((new Date).getTime(),e,s),o.containerEl.removeChild(t.selectorDiv)},drawFramePath:function(t,e){var s,i,o=t.cnf,r=this.sketchpad;if(!o.lay||!o.lay.length)return void console.warn("no layers to draw");for(s=0;s<o.lay.length;s+=1){switch(o.lay[s]){case r.LAYER_BACK:i=r.contextB2D;break;case r.LAYER_FRONT:i=r.context2D;break;default:i=r.context2D}i.save(),i.rotate(r.rotation*Math.PI/180),i.scale(r.scale,r.scale),i.translate(t.vpx,t.vpy),i.translate(-r.viewportX,-r.viewportY),i.scale(1/t.scl,1/t.scl),i.rotate(-t.rot*Math.PI/180),i.beginPath(),i.lineCap="butt",i.lineJoin="round",i.strokeStyle=o.col,i.lineWidth=o.siz,i.moveTo(e.x[0],e.y[0]),i.lineTo(e.x[1],e.y[1]),i.stroke(),i.restore()}}}),X.avaliableTools.push(T),P.prototype=Object.create(w.prototype),Object.assign(P.prototype,{layers:["F"],axis:7,color:{r:0,g:0,b:0,a:1},toolId:"mandala",toolLabel:"Mandala",lineWidth:1,keyCode:77,mirrorV:!1,mirrorH:!0,mirrorVH:!1,rainbow:!1,hideByDefault:!1,getToolConfig:function(){var t=w.prototype.getToolConfig.call(this);return Object.assign(t,{axis:this.axis,mirrorV:this.mirrorV,mirrorH:this.mirrorH,mirrorVH:this.mirrorVH,rainbow:this.rainbow})},setToolConfig:function(t){return w.prototype.setToolConfig.call(this,t),parseInt(t.axis,10)&&(this.axis=parseInt(t.axis,10)),this.mirrorV=t.mirrorV,this.mirrorH=t.mirrorH,this.mirrorVH=t.mirrorVH,this.rainbow=t.rainbow,this.dispatch("changeParams"),this},startInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=w.prototype.startInput.call(this,t,e,s);return o.mirrorV=this.mirrorV,o.mirrorH=this.mirrorH,o.mirrorVH=this.mirrorVH,o.rainbow=this.rainbow,o.axis=this.axis,o},getRbwColorStr:function(t,e){var s={r:0,g:0,b:0,a:1};return s.r=Math.abs(Math.floor(255*Math.sin(t/50)))%255,s.g=Math.abs(Math.floor(255*Math.cos(e/50)))%255,s.b=Math.abs(Math.floor(255*Math.cos(t/50)))%255,"rgba("+s.r+","+s.g+","+s.b+","+s.a+")"},drawFramePath:function(t,e){function s(t,e,s,i){return i%2==1&&(i=1),{x:Math.cos(s)*t-Math.sin(s)*e,y:Math.sin(s)*t+Math.cos(s)*e}}function i(e,s,i){e.save(),e.beginPath(),e.rotate(c.rotation*Math.PI/180),e.scale(c.scale,c.scale),e.translate(t.vpx,t.vpy),e.translate(-c.viewportX,-c.viewportY),e.scale(1/t.scl,1/t.scl),e.rotate(-t.rot*Math.PI/180),e.lineWidth=l.siz,l.rbw?e.strokeStyle=g.getRbwColorStr(s.x,s.y):e.strokeStyle=l.col,e.moveTo(s.x,s.y),e.lineTo(i.x,i.y),e.stroke(),e.restore()}var o,r,a,n,h,l=t.cnf,c=this.sketchpad,d=l.axs;if(!l.lay||!l.lay.length)return void console.warn("no layers to draw");var p,u,g=this;for(a=0;a<l.lay.length;a+=1){switch(l.lay[a]){case c.LAYER_BACK:o=c.contextB2D;break;case c.LAYER_FRONT:o=c.context2D;break;default:o=c.context2D}if(e&&e.x&&e.x.length>1)for(r=1;r<e.x.length;r+=1)for(n=0;n<d;n+=1)h=2*n*Math.PI/d,p=s(e.x[r-1],e.y[r-1],h,n),u=s(e.x[r],e.y[r],h,n),i(o,p,u),l.mrh&&(p=s(e.x[r-1],-e.y[r-1],h,n),u=s(e.x[r],-e.y[r],h,n),i(o,p,u)),l.mrv&&(p=s(-e.x[r-1],e.y[r-1],h,n),u=s(-e.x[r],e.y[r],h,n),i(o,p,u)),l.mrvh&&(p=s(-e.x[r-1],-e.y[r-1],h,n),u=s(-e.x[r],-e.y[r],h,n),i(o,p,u))}}}),X.avaliableTools.push(P),M.prototype=Object.create(w.prototype),Object.assign(M.prototype,{maxLayers:0,keyCode:32,toolLabel:"Move",toolId:"move-viewport",getCursor:function(){return{pointer:"move",border:"none",borderRadius:0,backgroundColor:"rgba(0,0,0,0)"}},startInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new u({sketchpad:o,id:t,tool:this.toolId});return r.tmpCursor=this.sketchpad.containerEl.style.cursor,r.startX=e,r.startY=s,r.viewportX=this.sketchpad.viewportX,r.viewportY=this.sketchpad.viewportY,o.containerEl.style.cursor="move",o.hudsEl.style.opacity=0,r},moveInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o={x:(e-t.startX)*(1/this.sketchpad.scale),y:(s-t.startY)*(1/this.sketchpad.scale)},r=this.sketchpad;o=this.rotate(-r.rotation,o);var a=t.viewportX-o.x,n=t.viewportY-o.y;i&&i.shiftKey&&(a=10*Math.round(a/10),n=10*Math.round(n/10)),this.sketchpad.setViewportPosition(a,n)},finishInput:function(t,e,s,i){i&&i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),this.moveInput(t,e,s,i),this.sketchpad.containerEl.style.cursor=t.tmpCursor,this.sketchpad.hudsEl.style.opacity=1},drawFramePath:function(){}}),X.avaliableTools.push(M),D.prototype=Object.create(w.prototype),Object.assign(D.prototype,{maxLayers:0,keyCode:27,toolLabel:"Null",toolId:"null",startInput:function(t){var e=this.sketchpad,s=new u({sketchpad:e,id:t,tool:this.toolId});return s.tmpCursor=this.sketchpad.containerEl.style.cursor,e.containerEl.style.cursor="none",s},moveInput:function(){},finishInput:function(t){this.sketchpad.containerEl.style.cursor=t.tmpCursor},drawFramePath:function(){}}),X.avaliableTools.push(D),O.prototype=Object.create(w.prototype),Object.assign(O.prototype,{color:{r:0,g:0,b:0,a:1},lineWidth:1,layers:["F"],keyCode:80,toolId:"pen",toolLabel:"Pen"}),X.avaliableTools.push(O),F.prototype=Object.create(w.prototype),Object.assign(F.prototype,{toolId:"rainbow",lineWidth:1,keyCode:66,toolLabel:"Rainbow",hideByDefault:!1,getCursor:function(){var t=parseInt(this.getSize()+1,10);return t+=10,{pointer:"crosshair",marginLeft:-t/2+"px",marginTop:-t/2+"px",width:t+"px",height:t+"px",border:"1px solid black",boxSizing:"border-box",borderRadius:"50%",backgroundColor:"rgba(0,0,0,0)"}},getColorStr:function(t,e){return this.color.r=Math.floor(256*Math.sin(t/50)),this.color.g=Math.floor(256*Math.cos(e/50)),this.color.b=Math.floor(256*Math.cos(t/50)),this.color.a=1,"rgba("+this.color.r+","+this.color.g+","+this.color.b+","+this.color.a+")"},drawFramePath:function(t,e){var s,i,o,r=t.cnf,a=this.sketchpad;if(o=null,!r.lay||!r.lay.length)return void console.warn("no layers to draw");var n,h;for(i=0;i<r.lay.length;i+=1){switch(r.lay[i]){case a.LAYER_BACK:o=a.contextB2D;break;case a.LAYER_FRONT:o=a.context2D;break;default:o=a.context2D}if(o.save(),o.rotate(a.rotation*Math.PI/180),o.scale(a.scale,a.scale),o.translate(t.vpx,t.vpy),o.translate(-a.viewportX,-a.viewportY),o.scale(1/t.scl,1/t.scl),o.rotate(-t.rot*Math.PI/180),e&&e.x&&e.y&&e.x.length>1)for(s=1;s<e.x.length;s+=1)n={x:e.x[s-1],y:e.y[s-1]},h={x:e.x[s],y:e.y[s]},o.beginPath(),o.strokeStyle=this.getColorStr(n.x,n.y),o.lineCap="miter",o.lineJoin="miter",o.lineWidth=r.siz+100/(10+this.distance(n.x,n.y,h.x,h.y)),o.moveTo(n.x,n.y),o.lineTo(h.x,h.y),o.stroke();o.restore()}}}),X.avaliableTools.push(F),z.prototype=Object.create(b.prototype),Object.assign(z.prototype,{layers:["F"],toolLabel:"Rectangle",toolId:"rectangle",keyCode:82,lineWidth:1,color:{r:0,g:0,b:0,a:1},fillColor:{r:255,g:80,b:0,a:0},startInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=this.sketchpad,r=new u({sketchpad:o,id:t,tool:this.toolId,color:this.getColorStr(),fillColor:this.getFillColorStr(),size:this.lineWidth,layers:this.layers});return r.firstX=e,r.firstY=s,r.selectorDiv=document.createElement("div"),r.selectorDiv.style.position="absolute",r.selectorDiv.style.border="1px solid black",r.selectorDiv.style.outline="1px dashed white",r.selectorDiv.style.outlineOffset="-1px",r.selectorDiv.style.display="block",this.sketchpad.centerViewport?(r.selectorDiv.style.left=this.sketchpad.width/2+e+"px",r.selectorDiv.style.top=this.sketchpad.height/2+s+"px"):(r.selectorDiv.style.left=e+"px",r.selectorDiv.style.top=s+"px"),r.selectorDiv.style.width="1px",r.selectorDiv.style.height="1px",o.containerEl.appendChild(r.selectorDiv),r.addPoint((new Date).getTime(),e,s),r},moveInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var o=t.firstX,r=t.firstY,a=Math.abs(s-r);i.shiftKey&&(e=e<o?o-a:o+a);var n=Math.min(o,e),h=Math.min(r,s),l=Math.max(o,e);a=Math.max(r,s)-h;var c=l-n;this.sketchpad.centerViewport?(t.selectorDiv.style.left=this.sketchpad.width/2+n-1+"px",t.selectorDiv.style.top=this.sketchpad.height/2+h-1+"px"):(t.selectorDiv.style.left=n+"px",t.selectorDiv.style.top=h+"px"),t.selectorDiv.style.width=c+"px",t.selectorDiv.style.height=a+"px"},finishInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10))
;var o=this.sketchpad,r=t.firstX,a=t.firstY,n=Math.abs(s-a);i.shiftKey&&(e=e<r?r-n:r+n),t.addPoint((new Date).getTime(),e,s),o.containerEl.removeChild(t.selectorDiv)},drawFramePath:function(t,e){var s,i,o=t.cnf,r=this.sketchpad;if(!o.lay||!o.lay.length)return void console.warn("no layers to draw");var a,n;for(s=0;s<o.lay.length;s+=1){switch(o.lay[s]){case r.LAYER_BACK:i=r.contextB2D;break;case r.LAYER_FRONT:i=r.context2D;break;default:i=r.context2D}i.save(),i.beginPath(),i.strokeStyle=o.col,i.fillStyle=o.fcl,i.lineWidth=o.siz,i.rotate(r.rotation*Math.PI/180),i.scale(r.scale,r.scale),i.translate(t.vpx,t.vpy),i.translate(-r.viewportX,-r.viewportY),i.scale(1/t.scl,1/t.scl),i.rotate(-t.rot*Math.PI/180),a={x:e.x[0],y:e.y[0]},n={x:e.x[1],y:e.y[1]},i.rect(a.x,a.y,n.x-a.x,n.y-a.y),i.fill(),i.stroke(),i.restore()}}}),X.avaliableTools.push(z),L.prototype=Object.create(w.prototype),Object.assign(L.prototype,{maxLayers:0,keyCode:32,toolLabel:"Rotate",toolId:"rotate-viewport",getCursor:function(){return{pointer:"default",border:"none",borderRadius:"50%",backgroundColor:"rgba(0,0,0,0)"}},startInput:function(t,e,s){var i=this.sketchpad,o=new u({sketchpad:i,id:t,tool:this.toolId});return o.startRotation=i.rotation,o.startX=e,o.startY=s,o.viewportX=this.sketchpad.viewportX,o.viewportY=this.sketchpad.viewportY,i.hudsEl.style.opacity=0,o},moveInput:function(t,e,s,i){var o=180*Math.atan2(e,s)/Math.PI-180*Math.atan2(t.startX,t.startY)/Math.PI;i.shiftKey&&(o=15*Math.round(o/15)),this.sketchpad.setRotation((-o+t.startRotation)%360)},finishInput:function(t){this.sketchpad.hudsEl.style.opacity=1},drawFramePath:function(){}}),X.avaliableTools.push(L),B.prototype=Object.create(w.prototype),Object.assign(B.prototype,{toolLabel:"Text",toolId:"type",font:"Arial",keyCode:84,color:{r:0,g:0,b:0,a:1},size:14,getToolConfig:function(){var t=w.prototype.getToolConfig.call(this);return Object.assign(t,{font:this.getFont(),size:this.getSize()})},setToolConfig:function(t){return w.prototype.setToolConfig.call(this,t),parseFloat(t.size)&&this.setSize(parseFloat(t.size)),t.font&&this.setFont(t.font),this.dispatch("changeParams"),this},setSize:function(t){return this.size=parseFloat(t),this.dispatch("changeParams"),this},getSize:function(){return this.size},setFont:function(t){return this.font=t,this.dispatch("changeParams"),this},getFont:function(){return this.font},startInput:function(t,e,s,i){function o(){if(a.typeInput.written)return!1;a.typeInput.written=!0,a.addPoint((new Date).getTime(),a.x-1,a.y),a.addPoint((new Date).getTime(),a.x,a.y),a.textContent=a.typeInput.value,r.inputs[667]=a,r.sendInputs(),r.drawInputs(),delete r.inputs[667],r.containerEl.removeChild(a.typeInput)}i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10));var r=this.sketchpad,a=new u({sketchpad:r,id:t,tool:this.toolId,color:this.getColorStr(),font:this.getFont(),size:this.getSize(),layers:this.layers});return a.typeInput=document.createElement("input"),a.typeInput.value="enter text here",a.typeInput.placeholder="enter text here",a.typeInput.style.border=0,a.typeInput.style.boxShadow="none",a.typeInput.style.position="absolute",a.typeInput.style.outline="0",a.typeInput.style.overflow="hidden",a.typeInput.style.padding=0,a.typeInput.style.margin=0,a.typeInput.style.fontFamily=this.getFont(),a.typeInput.style.fontSize=this.getSize()+"px",a.typeInput.style.display="inline-block",a.typeInput.style.color=this.getColorStr(),a.typeInput.style.backgroundColor="rgba(255,255,255,0)",this.sketchpad.centerViewport?(a.typeInput.style.left=this.sketchpad.width/2+e-1+"px",a.typeInput.style.top=this.sketchpad.height/2+s-this.getSize()/2+"px"):(a.typeInput.style.left=e-1+"px",a.typeInput.style.top=s-this.getSize()/2+"px"),a.typeInput.style.width=1e4+"px",a.typeInput.style.height=this.getSize()+"px",a.typeInput.style.lineHeight=this.getSize()+"px",a.typeInput.addEventListener("blur",o),a.typeInput.addEventListener("change",o),a.typeInput.addEventListener("keyup",function(t){13===t.keyCode&&o(),27===t.keyCode&&(a.typeInput.value="",o())}),r.containerEl.appendChild(a.typeInput),a},moveInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),s-=this.getSize()/2,this.sketchpad.centerViewport?(t.typeInput.style.left=this.sketchpad.width/2+e+"px",t.typeInput.style.top=this.sketchpad.height/2+s+"px"):(t.typeInput.style.left=e+"px",t.typeInput.style.top=s+"px")},finishInput:function(t,e,s,i){i.altKey&&(e=10*Math.round(e/10),s=10*Math.round(s/10)),t.x=e,t.y=s,t.typeInput.value="",t.typeInput.focus(),t.typeInput.select()},drawFramePath:function(t,e){var s,i,o=t.cnf,r=this.sketchpad;if(!o.lay||!o.lay.length)return void console.warn("no layers to draw");for(s=0;s<o.lay.length;s+=1){switch(o.lay[s]){case r.LAYER_BACK:i=r.contextB2D;break;case r.LAYER_FRONT:i=r.context2D;break;default:i=r.context2D}i.save(),i.rotate(r.rotation*Math.PI/180),i.scale(r.scale,r.scale),i.translate(t.vpx,t.vpy),i.translate(-r.viewportX,-r.viewportY),i.scale(1/t.scl,1/t.scl),i.rotate(-t.rot*Math.PI/180),i.font=o.siz+"px "+o.fnt,i.fillStyle=o.col,i.textAlign="left",i.textBaseline="middle",i.fillText(o.txt,e.x[0],e.y[0]),i.restore()}}}),X.avaliableTools.push(B),R.prototype=Object.create(e.prototype),Object.assign(R.prototype,{normalize:function(t,e,s){return t<e&&(t=e),t>s&&(t=s),t},triggerUpdate:function(){this.dispatch("change",{size:this.size})},setSize:function(t){this.size=this.normalize(t,this.minValue,this.maxValue),this.sliderEl.style.top=this.height*(this.size-this.minValue)/(this.maxValue-this.minValue)-.015*this.height+"px",this.triggerUpdate()}}),window.Thickness=R,t.fn.sketchpad=function(t){return t||(t={}),this.each(function(e,s){return t.containerEl=s,s.sketchpadModule?s.sketchpadModule:(s.sketchpadModule=new y(t),s.sketchpadModule)})},t.fn.pixelpicker=function(t){return t||(t={}),this.each(function(e,s){return t.containerEl=s,s.pixelpickerModule?s.pixelpickerModule:(s.pixelpickerModule=new c(t),s.pixelpickerModule)})},t.fn.colorpalette=function(t){return t||(t={}),this.each(function(e,i){return t.containerEl=i,i.colorpaletteModule?i.colorpaletteModule:(i.colorpaletteModule=new s(t),i.colorpaletteModule)})}}(jQuery);